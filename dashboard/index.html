 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <style>
    /* Chat Theme Variables */
    :root {
      /* Default Theme */
      --student-chat-bg: #3b82f6;
      --student-chat-text: #ffffff;
      --tutor-chat-bg: #f3f4f6;
      --tutor-chat-text: #1f2937;
      --chat-border-radius: 1rem;
      --chat-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Chat Theme Presets */
    .theme-ocean {
      --student-chat-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --student-chat-text: #ffffff;
      --tutor-chat-bg: #e0f2fe;
      --tutor-chat-text: #0277bd;
    }

    .theme-sunset {
      --student-chat-bg: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
      --student-chat-text: #4a5568;
      --tutor-chat-bg: #fff7ed;
      --tutor-chat-text: #c2410c;
    }

    .theme-forest {
      --student-chat-bg: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      --student-chat-text: #ffffff;
      --tutor-chat-bg: #f0fdf4;
      --tutor-chat-text: #166534;
    }

    .theme-midnight {
      --student-chat-bg: linear-gradient(135deg, #2c3e50 0%, #4a6741 100%);
      --student-chat-text: #ffffff;
      --tutor-chat-bg: #374151;
      --tutor-chat-text: #f9fafb;
    }

    .theme-candy {
      --student-chat-bg: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
      --student-chat-text: #ffffff;
      --tutor-chat-bg: #fef7ff;
      --tutor-chat-text: #be185d;
    }

    .theme-cyber {
      --student-chat-bg: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
      --student-chat-text: #ffffff;
      --tutor-chat-bg: #0f172a;
      --tutor-chat-text: #00d2ff;
      --chat-border-radius: 0.25rem;
      --chat-shadow: 0 0 20px rgba(0,210,255,0.3);
    }

    /* Theme base */
    :root { color-scheme: light; }
    .dark :root { color-scheme: dark; }
    .dark body { background-color: #0f172a; color: #e2e8f0; }
    .dark .bg-white { background-color: #0b1220 !important; }
    .dark .text-gray-800 { color: #e2e8f0 !important; }
    .dark .text-gray-700 { color: #cbd5e1 !important; }
    .dark .text-gray-600 { color: #94a3b8 !important; }
    .dark .bg-gray-50 { background-color: #0f172a !important; }
    .dark .bg-gray-100 { background-color: #0b1220 !important; }
    .dark .border-gray-200 { border-color: #1f2937 !important; }
    
    /* Dark mode sidebar buttons */
    .dark .icon-sidebar { background-color: #1f2937 !important; }
    .dark .icon-sidebar a { color: #e2e8f0 !important; }
    .dark .icon-sidebar a i { color: #e2e8f0 !important; }
    .dark .icon-sidebar a.active { background-color: #374151 !important; }
    
    /* Dark mode chat input */
    .dark #chat-box { 
      background-color: #1f2937 !important; 
      color: #e2e8f0 !important; 
      border-color: #374151 !important; 
    }
    .dark #chat-box::placeholder { color: #abaf9c !important; }
    
    /* Dark mode payment inputs and buttons */
    .dark #depositAmount { 
      background-color: #1f2937 !important; 
      color: #e2e8f0 !important; 
      border-color: #374151 !important; 
    }
    .dark #depositAmount::placeholder { color: #9ca3af !important; }
    .dark .bg-gray-200 { background-color: #374151 !important; }
    .dark .text-gray-700 { color: #e2e8f0 !important; }
    .dark .hover\:bg-gray-300:hover { background-color: #4b5563 !important; }

    /* Dark mode - Order Modal */
    .dark #orderModal .bg-white { background-color: #0b1220 !important; }
    .dark #orderModal .sticky.top-0.bg-white { background-color: #0b1220 !important; }
    .dark #orderModal .border,
    .dark #orderModal .border-b,
    .dark #orderModal .border-t,
    .dark #orderModal .border-l,
    .dark #orderModal .border-r { border-color: #1f2937 !important; }
    .dark #orderModal .border-gray-200 { border-color: #1f2937 !important; }
    .dark #orderModal .border-gray-300 { border-color: #374151 !important; }

    .dark #orderModal h2,
    .dark #orderModal h3,
    .dark #orderModal h4 { color: #e2e8f0 !important; }
    .dark #orderModal p,
    .dark #orderModal label,
    .dark #orderModal span { color: #cbd5e1 !important; }
    .dark #orderModal .text-gray-800 { color: #e2e8f0 !important; }
    .dark #orderModal .text-gray-700 { color: #cbd5e1 !important; }
    .dark #orderModal .text-gray-600 { color: #94a3b8 !important; }

    .dark #orderModal select,
    .dark #orderModal input[type="text"],
    .dark #orderModal input[type="number"],
    .dark #orderModal input[type="file"],
    .dark #orderModal textarea {
      background-color: #111827 !important;
      color: #e5e7eb !important;
      border-color: #374151 !important;
    }
    .dark #orderModal ::placeholder { color: #9ca3af !important; }

    /* Section color tweaks */
    .dark #orderModal .bg-blue-50,
    .dark #orderModal .bg-green-50,
    .dark #orderModal .bg-purple-50,
    .dark #orderModal .bg-orange-50 { background-color: #0f172a !important; }

    .dark #orderModal .text-blue-800 { color: #93c5fd !important; }
    .dark #orderModal .text-green-800 { color: #86efac !important; }
    .dark #orderModal .text-purple-800 { color: #d8b4fe !important; }
    .dark #orderModal .text-orange-800 { color: #fdba74 !important; }
    .dark #orderModal .bg-yellow-50 { background-color: #0f172a !important; }
    .dark #orderModal .text-yellow-800 { color: #fde68a !important; }

    /* Gradient section */
    .dark #orderModal .from-red-50.to-pink-50 {
      background-image: none !important;
      background-color: #111827 !important;
    }
    .dark #orderModal .border-red-200 { border-color: #374151 !important; }
    .dark #orderModal .text-red-800 { color: #fca5a5 !important; }

    /* Drag and drop area */
    .dark #orderModal .border-dashed { border-color: #374151 !important; }
    .dark #orderModal .text-gray-600 { color: #94a3b8 !important; }
    .dark #orderModal .text-gray-500 { color: #9ca3af !important; }
    .dark #orderModal .text-gray-400 { color: #9ca3af !important; }

    /* Step 5: dark mode text and date inputs */
    .dark #orderModal .from-blue-50.to-indigo-50 {
      background-image: none !important;
      background-color: #0f172a !important;
    }
    .dark #orderModal .border-blue-200 { border-color: #374151 !important; }
    .dark #orderModal .text-blue-700 { color: #93c5fd !important; }
    .dark #orderModal .text-blue-800 { color: #93c5fd !important; }
    .dark #orderModal .text-green-700 { color: #86efac !important; }
    .dark #orderModal .text-green-500 { color: #22c55e !important; }
    .dark #orderModal .text-yellow-800 { color: #fde68a !important; }

    .dark #orderModal #dueDateTime,
    .dark #orderModal input[type="datetime-local"],
    .dark #orderModal input[type="date"],
    .dark #orderModal input[type="time"] {
      background-color: #111827 !important;
      color: #e5e7eb !important;
      border-color: #374151 !important;
    }
    .dark #orderModal #dueDateTime::placeholder,
    .dark #orderModal input[type="datetime-local"]::placeholder,
    .dark #orderModal input[type="date"]::placeholder,
    .dark #orderModal input[type="time"]::placeholder {
      color: #9ca3af !important;
    }
    /* Date/time picker icon for Chromium/WebKit */
    .dark #orderModal input[type="date"]::-webkit-calendar-picker-indicator,
    .dark #orderModal input[type="datetime-local"]::-webkit-calendar-picker-indicator,
    .dark #orderModal input[type="time"]::-webkit-calendar-picker-indicator {
      filter: invert(0.85) brightness(1.2);
    }

    /* Edit Profile placeholders in dark theme */
    .dark #edit-profile-form input::placeholder,
    .dark #edit-profile-form textarea::placeholder {
      color: #9ca3af !important;
    }

    /* Inline edit placeholders (profile section) */
    #profile .inline-edit-field { color: #2563eb !important; }
    #profile .inline-edit-field::placeholder { color: #2563eb !important; }
    .dark #profile .inline-edit-field { color: #60a5fa !important; }
    .dark #profile .inline-edit-field::placeholder { color: #60a5fa !important; }

    /* Dynamic Chat Message Styling */
    .student-message {
      background: var(--student-chat-bg) !important;
      color: var(--student-chat-text) !important;
      border-radius: var(--chat-border-radius) !important;
      box-shadow: var(--chat-shadow) !important;
      margin-left: auto;
      max-width: 70%;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      position: relative;
      animation: slideInRight 0.3s ease-out;
    }

    .tutor-message {
      background: var(--tutor-chat-bg) !important;
      color: var(--tutor-chat-text) !important;
      border-radius: var(--chat-border-radius) !important;
      box-shadow: var(--chat-shadow) !important;
      margin-right: auto;
      max-width: 70%;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      position: relative;
      animation: slideInLeft 0.3s ease-out;
    }

    /* Chat Animation */
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Theme Preview Cards */
    .theme-preview {
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .theme-preview:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .theme-preview.selected {
      ring: 3px;
      ring-color: #3b82f6;
      transform: translateY(-2px);
    }

    /* Settings Modal */
    .settings-modal {
      backdrop-filter: blur(10px);
      background: rgba(0,0,0,0.5);
    }

    .settings-content {
      max-height: 90vh;
      overflow-y: auto;
    }

    /* Sidebar Tooltip Fix */
    .tooltip {
      position: absolute;
      left: 4rem;
      background-color: #374151; /* Dark Gray */
      color: #ffffff;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      opacity: 0;
      transform: translateX(10px);
      transition: opacity 0.3s, transform 0.3s;
      white-space: nowrap;
    }

    .icon-sidebar a:hover .tooltip {
      opacity: 1;
      transform: translateX(0);
    }

    /* Active State for Sidebar */
    .active {
      background-color: #60a5fa; /* Blue */
      border-radius: 0.375rem;
    }

    /* Sidebar Styles */
    .icon-sidebar {
      background-color: #bfdbfe; /* Light Blue */
      height: 100%;
      position: fixed;
      top: 0;
      left: 0;
      width: 4rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 1rem 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    /* Mobile Sidebar */
    @media (max-width: 640px) {
      .icon-sidebar {
        top: auto;
        bottom: 0;
        width: 100%;
        height: 4rem;
        flex-direction: row;
        justify-content: space-around;
      }

      .tooltip {
        left: 50%;
        transform: translateX(-50%);
        bottom: 4rem;
      }
    }

    /* Dropdown Animation */
    #dropdown-menu {
      transition: opacity 0.3s ease, transform 0.3s ease;
      transform-origin: top right;
    }

    #dropdown-menu.hidden {
      opacity: 0;
      transform: scale(0.95);
      pointer-events: none;
    }


    @media (min-width: 768px) {
  #profile-card {
    display: flex;
    flex-direction: row; /* Move to horizontal layout */
    align-items: flex-start;
  }

  /* Ensure profile image is aligned to the left */
  #profile-picture {
    justify-content: flex-start;
  }

  /* Ensure details (name, bio, etc.) are on the right */
  #profile-card div {
    text-align: left;
    align-items: flex-start;
  }
}


  </style>
</head>

<body class="bg-gray-100 font-sans" x-data x-init="document.documentElement.classList.toggle('dark', localStorage.getItem('theme')==='dark')">

<!-- Sidebar -->
<div class="icon-sidebar hidden md:hidden lg:flex">
  <a href="#" class="relative mb-6 p-4 active" onclick="showSection('overview')">
    <i class="fas fa-home text-xl text-gray-700"></i>
    <span class="tooltip">Dashboard</span>
  </a>
  <a href="#" class="relative mb-6 p-4" onclick="showSection('assignments')">
    <i class="fas fa-book text-xl text-gray-700"></i>
    <span class="tooltip">Assignments</span>
  </a>
  <a href="#" class="relative mb-6 p-4" onclick="showSection('messages')">
    <i class="fas fa-comments text-xl text-gray-700"></i>
    <span class="tooltip">Messages</span>
    <span id="student-chat-badge" class="absolute -top-0.5 -right-0.5 bg-red-600 text-white text-[10px] rounded-full px-1.5 py-0.5 hidden">0</span>
  </a>
  <a href="#" class="relative mb-6 p-4" onclick="showSection('payments')">
    <i class="fas fa-wallet text-xl text-gray-700"></i>
    <span class="tooltip">Payments</span>
  </a>
  <a href="#" class="relative mb-6 p-4" onclick="showSection('profile')">
    <i class="fas fa-user text-xl text-pink-700"></i>
    <span class="tooltip">Profile</span>
  </a>
</div>

<!-- Bottom Navigation for Medium Screens -->
<nav class="fixed bottom-0 left-0 right-0 bg-gray-800 text-white flex justify-around items-center p-2 md:flex lg:hidden z-20">
  <button onclick="showSection('overview')" class="flex flex-col items-center">
    <i class="fas fa-home text-xl"></i>
    <span class="text-xs"></span>
  </button>
  <button onclick="showSection('assignments')" class="flex flex-col items-center">
    <i class="fas fa-book text-xl"></i>
    <span class="text-xs"></span>
  </button>
  <button onclick="showSection('messages')" class="flex flex-col items-center relative">
    <i class="fas fa-comments text-xl"></i>
    <span class="text-xs"></span>
    <span id="student-chat-badge-mobile" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] rounded-full px-1.5 py-0.5 hidden">0</span>
  </button>
  <button onclick="showSection('payments')" class="flex flex-col items-center">
    <i class="fas fa-wallet text-xl"></i>
    <span class="text-xs"></span>
  </button>
  <button onclick="showSection('profile')" class="flex flex-col items-center">
    <i class="fas fa-user text-xl"></i>
    <span class="text-xs"></span>
  </button>
</nav>

<!-- Header -->
<header class="bg-white shadow-md fixed top-0 left-0 right-0 z-10 px-6 py-4 flex items-center justify-between">
  
  <!-- Small Screens: Back Button + Section Name -->
  <div id="mobile-header" class="flex items-center space-x-4 lg:hidden">
    <h1 id="section-title-mobile" class="text-xl font-semibold text-gray-800"></h1>
  </div>

  <!-- Large Screens: Section Name in Center -->
  <h1 id="section-title-large" class="hidden lg:block text-2xl font-bold text-gray-800 mx-auto"></h1>

  <!-- Profile Icon (Large Screens Only) -->
  <div id="profile-section" class="hidden lg:flex relative">
    <div 
      class="w-10 h-10 rounded-full cursor-pointer flex items-center justify-center bg-gray-300 text-white font-bold overflow-hidden ring-2 ring-blue-400 hover:ring-4 hover:scale-105 transition-transform shadow-lg"
      onclick="toggleDropdown()"
      id="profile-icon"
    >
      <img id="profile-icon-image" src="" alt="Profile" class="w-10 h-10 object-cover rounded-full hidden">
      <span id="profile-initials" class="text-xl">👾</span>
    </div>

    <!-- Dropdown Menu -->
    <div id="dropdown-menu" class="hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-md">
      <a href="#" class="block px-4 py-2 text-gray-800 hover:bg-gray-100" onclick="showSection('profile')">View Profile</a>
      <a href="#" class="block px-4 py-2 text-gray-800 hover:bg-gray-100" onclick="confirmLogout()">Logout</a>
    </div>
  </div>

</header>


<!-- Main Content (Ensuring Proper Layout for All Screens) -->
<main class="md:ml-16 md:pl-6 lg:ml-16 lg:pl-6 pt-20 pb-20 md:pb-6">  
<!-- Overview Section -->
<section id="overview" class="p-6 mb-4 md:mb-16 max-h-[calc(100vh-140px)] md:max-h-[calc(100vh-100px)] overflow-y-auto">

  <!-- Quick Action Button -->
  <div class="mb-6">
    <button onclick="openOrderModal()" 
       class="inline-flex items-center bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 shadow-lg">
      <i class="fas fa-plus mr-2"></i>Place New Order
    </button>
  </div>
  
      <!-- Dashboard Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Active Assignments Card -->
        <div class="bg-white p-6 rounded-lg shadow transition-transform duration-300 hover:scale-105">
          <div class="flex items-center space-x-4">
            <span class="text-blue-600 text-3xl">📚</span>
            <div>
              <h2 class="text-lg font-semibold text-blue-800">Active Assignments</h2>
              <p class="text-blue-600 mt-2 text-xl font-bold">3 in progress</p>
            </div>
          </div>
        </div>

        <!-- Upcoming Deadlines Card -->
        <div class="bg-white p-6 rounded-lg shadow transition-transform duration-300 hover:scale-105">
          <div class="flex items-center space-x-4">
            <span class="text-green-600 text-3xl">⏰</span>
            <div>
              <h2 class="text-lg font-semibold text-green-800">Upcoming Deadlines</h2>
              <p class="text-green-600 mt-2 text-xl font-bold">3 approaching</p>
            </div>
          </div>
        </div>

        <!-- Recent Messages Card -->
        <div class="bg-white p-6 rounded-lg shadow transition-transform duration-300 hover:scale-105">
          <div class="flex items-center space-x-4">
            <span class="text-yellow-600 text-3xl">💬</span>
            <div>
              <h2 class="text-lg font-semibold text-yellow-800">Recent Messages</h2>
              <p class="text-yellow-600 mt-2 text-xl font-bold">2 unread</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Info / Stats Section -->
      <div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Pending Payments -->
        <div class="bg-white p-6 rounded-lg shadow transition-transform duration-300 hover:scale-105">
          <div class="flex items-center space-x-4">
            <span class="text-purple-600 text-3xl">💳</span>
            <div>
              <h2 class="text-lg font-semibold text-purple-800">Pending Payments</h2>
              <p class="text-purple-600 mt-2 text-xl font-bold">$150 due</p>
            </div>
          </div>
        </div>

        <!-- Profile Updates -->
        <div class="bg-white p-6 rounded-lg shadow transition-transform duration-300 hover:scale-105">
          <div class="flex items-center space-x-4">
            <span class="text-teal-600 text-3xl">👤</span>
            <div>
              <h2 class="text-lg font-semibold text-teal-800">Profile Updates</h2>
              <p class="text-teal-600 mt-2 text-xl font-bold">1 new update</p>
            </div>
          </div>
        </div>

        <!-- New Feedback -->
        <div class="bg-white p-6 rounded-lg shadow transition-transform duration-300 hover:scale-105">
          <div class="flex items-center space-x-4">
            <span class="text-pink-600 text-3xl">📝</span>
            <div>
              <h2 class="text-lg font-semibold text-pink-800">New Feedback</h2>
              <p class="text-pink-600 mt-2 text-xl font-bold">1 new comment</p>
            </div>
          </div>
        </div>
      </div>
</section>

    <!-- Assignments Section -->
<section id="assignments" class="p-6 pb-20 md:pb-6 hidden">
  
    <!-- Assignments Grid -->
    <div id="assignments-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 w-full">
      <!-- Dynamic assignments will be loaded here -->
    </div>
  </section>
  
<!-- Messages Section -->
<section id="messages" class="p-6 pb-20 md:pb-6 hidden">
  <script src="https://meme-s6lb.onrender.com/socket.io/socket.io.js"></script>

  <!-- Assignment Selection View -->
  <div id="assignment-selection-view" class="transition-all duration-500 ease-in-out">
    <div class="text-center mb-8">
      <h2 class="text-3xl font-bold text-gray-800 mb-2">Select an Assignment</h2>
      <p class="text-gray-600">Choose an assignment to start chatting with your tutor</p>
    </div>
    
    <div class="max-w-4xl mx-auto">
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-semibold text-gray-800">Your Assignments</h3>
          <button id="refresh-assignments" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
            <i class="fas fa-sync-alt mr-2"></i>Refresh
          </button>
        </div>
        
        <div class="flex flex-col space-y-3" id="assignment-chat-list">
          <!-- Dynamic Assignment List will be inserted here -->
        </div>
        
        <style>
          .assignment-unread-badge{position:absolute;top:0.25rem;right:0.25rem}
          .assignment-card {
            transition: all 0.3s ease;
            transform: translateY(0);
          }
          .assignment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
          }
        </style>
      </div>
    </div>
  </div>

  <!-- Chat View (Initially Hidden) -->
  <div id="chat-view" class="hidden transition-all duration-500 ease-in-out">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center space-x-4">
        <button id="back-to-assignments" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition duration-200">
          <i class="fas fa-arrow-left text-gray-600"></i>
        </button>
        <div>
          <h2 class="text-2xl font-semibold text-gray-800">Chat</h2>
          <p class="text-sm text-gray-600">Assignment: <span id="active-assignment-title">None</span></p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <!-- Chat History -->
      <div id="chat-history" class="bg-gray-50 p-6 h-96 overflow-y-auto space-y-4">
        <!-- Messages will be dynamically inserted here -->
      </div>

      <!-- Message Input -->
      <div class="p-4 border-t bg-white">
        <div class="flex items-end space-x-3">
          <textarea id="chat-box" class="flex-1 border border-gray-300 rounded-lg p-3 resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                    placeholder="Type your message..." rows="2"></textarea>
          <button id="send-message" class="px-6 py-3 bg-gray-400 text-white rounded-lg shadow cursor-not-allowed transition duration-200" disabled>
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <audio id="student-new-message-audio" src="audio/receive.mp3" preload="auto"></audio>
  <audio id="student-send-audio" src="audio/send.mp3" preload="auto"></audio>
</section>


<!-- Payments Section -->
<section id="payments" class="p-4 pb-20 md:pb-6 hidden">

  <!-- Balance Notification -->
  <div id="balanceNotification" class="hidden mb-6 p-4 bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-lg">
    <div class="flex items-center space-x-3">
      <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
      <div>
        <h3 class="font-semibold text-red-800">Top Up Required</h3>
        <p class="text-red-700 text-sm">Your account balance is insufficient for pending assignments. Please add funds to continue.</p>
      </div>
    </div>
  </div>

  <!-- Profile & Wallet Section -->
  <div class="flex justify-start items-center mb-6 space-x-4 p-4">
    <!-- Profile Icon -->
    <div class="w-12 h-12 rounded-full overflow-hidden ring-2 ring-blue-400 shadow-md">
      <img id="payments-profile-image" src="" alt="Profile" class="w-full h-full object-cover">
    </div>

    <!-- Name & Wallet Balance -->
    <div class="flex flex-col">
      <span class="font-semibold text-xl text-gray-800" id="userName">John Doe</span>
      <span class="text-lg font-bold text-emerald-600" id="userBalance">$0.00</span>
      <button onclick="openWithdrawPrompt()" class="mt-2 inline-flex items-center bg-red-600 text-white px-3 py-2 rounded-md text-sm hover:bg-red-700">
        <i class="fas fa-money-bill-wave mr-2"></i>Request Withdraw
      </button>
    </div>
  </div>

  <!-- Add Funds Section -->
  <div class="mb-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Add Funds to Your Account</h2>
    
    <!-- Amount Input -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-2">Amount to Add</label>
      <div class="flex items-center space-x-4">
        <div class="relative flex-1 max-w-xs">
          <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
          <input type="number" id="depositAmount" min="10" step="0.01" 
                 class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                 placeholder="0.00">
        </div>
        <div class="flex space-x-2">
          <button onclick="setAmount(25)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">$25</button>
          <button onclick="setAmount(50)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">$50</button>
          <button onclick="setAmount(100)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">$100</button>
        </div>
      </div>
    </div>

    <!-- Payment Methods -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      
      <!-- Paystack -->
      <div class="bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent hover:border-blue-500"
           onclick="selectPaymentMethod('paystack')">
        <div class="text-center">
          <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-credit-card text-2xl text-blue-600"></i>
          </div>
          <h3 class="font-semibold text-gray-800 mb-2">Paystack</h3>
          <p class="text-sm text-gray-600">Credit/Debit Cards</p>
          <p class="text-xs text-green-600 mt-2">✓ Instant Processing</p>
        </div>
      </div>

      <!-- PayPal -->
      <div class="bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent hover:border-blue-500"
           onclick="selectPaymentMethod('paypal')">
        <div class="text-center">
          <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fab fa-paypal text-2xl text-blue-600"></i>
          </div>
          <h3 class="font-semibold text-gray-800 mb-2">PayPal</h3>
          <p class="text-sm text-gray-600">Secure Online Payment</p>
          <p class="text-xs text-green-600 mt-2">✓ Instant Processing</p>
        </div>
      </div>

      <!-- CashApp (Bitcoin) -->
      <div class="bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent hover:border-green-500"
           onclick="selectPaymentMethod('cashapp')">
        <div class="text-center">
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-mobile-alt text-2xl text-green-600"></i>
          </div>
          <h3 class="font-semibold text-gray-800 mb-2">CashApp</h3>
          <p class="text-sm text-gray-600">Bitcoin Only</p>
          <p class="text-xs text-orange-600 mt-2">⏳ Manual Approval</p>
        </div>
      </div>

      <!-- Bitcoin -->
      <div class="bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-lg transition-shadow border-2 border-transparent hover:border-yellow-500"
           onclick="selectPaymentMethod('bitcoin')">
        <div class="text-center">
          <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fab fa-bitcoin text-2xl text-yellow-600"></i>
          </div>
          <h3 class="font-semibold text-gray-800 mb-2">Bitcoin</h3>
          <p class="text-sm text-gray-600">Direct Transfer</p>
          <p class="text-xs text-orange-600 mt-2">⏳ Manual Approval</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment History -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">Payment History</h2>
    <div id="paymentsList" class="space-y-3"></div>
  </div>
</section>


<!-- Profile Section -->
<section id="profile" class="p-6 pb-20 md:pb-6 max-w-6xl mx-auto hidden">

  <!-- Profile Card (Medium & Large Screens) -->
  <div id="profile-card" class="rounded-xl p-8 border border-gray-200 flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-x-8">

    <!-- Profile Picture (Small & Medium Screens - Popup on Click) -->
    <div class="flex justify-center md:hidden">
      <img id="profile-picture"
          src="" 
          alt="Profile Picture"
          class="w-24 h-24 rounded-full border-4 border-blue-500 shadow-lg hover:scale-105 transition-all duration-300 cursor-pointer"
          onclick="openProfilePicturePopup()">
    </div>

    <!-- Profile Picture (Large Screens - Direct Upload on Click) -->
    <div class="hidden md:flex justify-center">
      <label for="profile-upload" class="cursor-pointer">
          <img id="profile-picture-lg"
              src=""
              alt="Profile Picture"
              class="w-32 md:w-36 lg:w-44 h-32 md:h-36 lg:h-44 rounded-full border-4 border-gray-300 shadow-lg hover:scale-105 transition-all duration-300">
          <div id="profile-upload-placeholder" class="text-xs text-gray-500 mt-2"></div>
      </label>
      <input type="file" id="profile-upload" class="hidden">
    </div>

<!-- User Info -->
<div class="flex-1 text-left w-full"> 
  <h2 id="user-name" class="text-3xl font-semibold text-gray-800">John Doe</h2>
  <p id="user-email" class="text-md text-blue-600 font-awesome underline">johndoe@example.com</p>

  <!-- Phone -->
  <div class="mt-2">
    <p class="text-gray-600 text-sm font-medium">Phone:</p>
    <p id="user-phone" class="text-gray-800">Not set</p>
  </div>
  
  <!-- Bio -->
  <div class="mt-4">
    <p class="text-gray-600 text-sm font-medium">Bio:</p>
    <p id="user-bio" class="text-gray-800">No bio available.</p>
  </div>

  <!-- Wallet Balance -->
  <div class="mt-4">
    <p class="text-gray-600 text-sm font-medium">Wallet Balance</p>
    <h3 id="wallet-balance" class="text-2xl font-semibold text-green-600">$0.00</h3>
  </div>

<!-- Profile Completion -->
<!-- Profile progress removed as requested -->

<!-- Social media removed -->
</div>
</div>

<!-- Profile Action Buttons -->
<div class="flex flex-col sm:flex-row justify-end gap-3 mt-6 w-full">
  <button onclick="openChatSettings()" 
      class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-full shadow-xl hover:from-purple-600 hover:to-pink-600 transition-all duration-300 flex items-center justify-center">
      <i class="fas fa-palette mr-2"></i>Customize Chat
  </button>
  <button onclick="enableEditProfile()" 
      class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-full shadow-xl hover:bg-blue-700 transition-all duration-300">
      Edit Profile
  </button>
</div>



<!-- Edit Profile Section (Full-Screen Mode) -->
<div id="edit-profile-form" class="hidden bg-white rounded-xl shadow-xl p-6 inset-0">
  
  <!-- Back Button -->
  <button onclick="cancelEdit()" class="text-gray-600 text-2xl mb-4">←</button>

  <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Edit Profile</h2>

  <!-- Profile Picture Edit -->
  <div class="flex justify-center">
    <img id="edit-profile-picture"
      src="https://i.imgur.com/vrNbBwT.png" 
      alt="Profile Picture"
      class="w-32 h-32 lg:w-44 lg:h-44 rounded-full border-4 border-gray-300 shadow-lg cursor-pointer"
      onclick="openProfilePicturePopup()">
  </div>

  <!-- Name, Bio, Email, Phone -->
  <div class="mt-6 grid lg:grid-cols-2 gap-6">
    <div>
      <label class="block text-gray-700 font-semibold mb-2">Name</label>
      <input type="text" id="edit-username" class="w-full border rounded-lg p-3 shadow-sm">
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-2">Bio</label>
      <textarea id="edit-bio" rows="4" class="w-full border rounded-lg p-3 shadow-sm"></textarea>
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-2">Email</label>
      <input type="email" id="edit-email" class="w-full border rounded-lg p-3 shadow-sm" placeholder="Enter email">
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-2">Phone Number</label>
      <input type="text" id="edit-phone" class="w-full border rounded-lg p-3 shadow-sm" placeholder="e.g. +1 555 123 4567">
    </div>
  </div>

  <!-- Password Update -->
  <div class="mt-6">
    <label class="block text-gray-700 font-semibold mb-2">Change Password</label>
    <button onclick="openPasswordPopup()" class="w-full border rounded-lg p-3 text-left shadow-sm bg-gray-100">
      Update Password
    </button>
  </div>

  <!-- Save Button -->
  <div class="mt-6 flex justify-end">
    <button onclick="saveProfile()" class="px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-lg hover:bg-green-600 transition-all">
        Save Changes
    </button>
  </div>

</div>


<!-- Popup Modal for Phone Number -->
<div id="phone-popup" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center">
  <div class="bg-white rounded-lg p-6 w-4/5 max-w-lg">
    <h3 class="text-lg font-semibold mb-4">Add Phone Number</h3>
    
    <!-- Country Code and Phone Number (Horizontal Layout) -->
    <div class="flex mb-4 space-x-4">
      <div class="w-1/3">
        <label class="block text-gray-700">Country Code</label>
        <select id="country-code" class="w-full border rounded-lg p-3">
          <option value="+1">+1 (USA)</option>
          <option value="+44">+44 (UK)</option>
          <option value="+91">+91 (India)</option>
          <!-- Add more country codes as needed -->
        </select>
      </div>

      <div class="flex-1">
        <label class="block text-gray-700">Phone Number</label>
        <input type="text" id="new-phone-number" class="w-full border rounded-lg p-3" placeholder="Enter phone number">
      </div>
    </div>

    <!-- Popup Actions -->
    <div class="flex justify-between">
      <button onclick="closePhonePopup()" class="text-gray-500 hover:text-gray-700">Cancel</button>
      <button onclick="savePhoneNumber()" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Save</button>
    </div>
  </div>
</div>

  <!-- Profile Picture Popup (replaced with simple file picker) -->
  <div id="profile-picture-popup" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-lg w-80">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Change Profile Picture</h3>
      <input type="file" id="popup-profile-upload" accept="image/*" class="w-full border rounded p-2" />
      <div class="flex justify-end space-x-2 mt-4">
        <button class="px-4 py-2 bg-gray-200 rounded" onclick="closeProfilePicturePopup()">Cancel</button>
        <button class="px-4 py-2 bg-blue-600 text-white rounded" onclick="savePopupProfileImage()">Save</button>
      </div>
    </div>
  </div>

  <!-- Password Update Popup -->
  <div id="password-popup" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-lg w-80">
      <h3 class="text-lg font-semibold text-gray-800">Change Password</h3>
      <input type="password" id="current-password" class="w-full border rounded-lg p-3 shadow-sm mt-2" placeholder="Current Password">
      <input type="password" id="new-password" class="w-full border rounded-lg p-3 shadow-sm mt-2" placeholder="New Password">
      <input type="password" id="confirm-password" class="w-full border rounded-lg p-3 shadow-sm mt-2" placeholder="Confirm Password">
      <button class="text-blue-500 mt-2" onclick="forgotPassword()">Forgot Password?</button>
      <button class="mt-4 w-full px-4 py-2 bg-green-500 text-white rounded-lg" onclick="saveNewPassword()">Change Password</button>
      <button class="mt-2 w-full px-4 py-2 bg-gray-300 rounded-lg" onclick="closePasswordPopup()">Cancel</button>
    </div>
  </div>


    <!-- Advanced Settings -->
    <div class="p-8 rounded-xs shadow-xl mt-8">
      <h2 class="text-2xl font-semibold text-gray-800 mb-6">Advanced Settings</h2>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Notifications -->
        <div>
          <h3 class="font-semibold text-gray-700 mb-2">Notifications</h3>
          <label class="flex items-center mb-2">
            <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-500" checked>
            <span class="ml-2 text-gray-600">Email Notifications</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-500">
            <span class="ml-2 text-gray-600">SMS Notifications</span>
          </label>
        </div>
  
        <!-- Theme Preferences -->
        <div>
          <h3 class="font-semibold text-gray-700 mb-2">Theme</h3>
          <label class="flex items-center mb-2">
            <input type="radio" name="theme" class="form-radio h-5 w-5 text-blue-500" value="light" checked>
            <span class="ml-2 text-gray-600">Light Mode</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="theme" class="form-radio h-5 w-5 text-blue-500" value="dark">
            <span class="ml-2 text-gray-600">Dark Mode</span>
          </label>
        </div>
      </div>
    </div>
  </section>  
  </main>

  <!-- Order Modal -->
  <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <!-- Modal Header -->
      <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-800">Place New Order</h2>
        <button onclick="closeOrderModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <!-- Modal Content -->
      <div class="p-6">
        <form id="orderForm" class="space-y-6">
          
          <!-- Step 1: Course Selection -->
          <div class="bg-blue-50 p-6 rounded-lg">
            <h3 class="text-lg font-semibold text-blue-800 mb-4">
              <i class="fas fa-book mr-2"></i>Step 1: Select Your Course
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="course-category">
                <h4 class="font-medium text-gray-700 mb-2">Liberal Arts</h4>
                <select id="liberalArtsSubject" class="w-full p-2 border rounded-md">
                  <option value="">Select Subject</option>
                  <option value="English Literature">English Literature</option>
                  <option value="History">History</option>
                  <option value="Philosophy">Philosophy</option>
                  <option value="Psychology">Psychology</option>
                  <option value="Sociology">Sociology</option>
                  <option value="Political Science">Political Science</option>
                </select>
              </div>
              
              <div class="course-category">
                <h4 class="font-medium text-gray-700 mb-2">Business</h4>
                <select id="businessSubject" class="w-full p-2 border rounded-md">
                  <option value="">Select Subject</option>
                  <option value="Business Administration">Business Administration</option>
                  <option value="Marketing">Marketing</option>
                  <option value="Finance">Finance</option>
                  <option value="Economics">Economics</option>
                  <option value="Management">Management</option>
                  <option value="Accounting">Accounting</option>
                </select>
              </div>
              
              <div class="course-category">
                <h4 class="font-medium text-gray-700 mb-2">Sciences</h4>
                <select id="scienceSubject" class="w-full p-2 border rounded-md">
                  <option value="">Select Subject</option>
                  <option value="Biology">Biology</option>
                  <option value="Chemistry">Chemistry</option>
                  <option value="Environmental Science">Environmental Science</option>
                  <option value="Health Sciences">Health Sciences</option>
                  <option value="Nursing">Nursing</option>
                </select>
              </div>
              
              <div class="course-category">
                <h4 class="font-medium text-gray-700 mb-2">Technical Courses</h4>
                <select id="technicalSubject" class="w-full p-2 border rounded-md">
                  <option value="">Select Subject</option>
                  <option value="Mathematics">Mathematics</option>
                  <option value="Physics">Physics</option>
                  <option value="Engineering">Engineering</option>
                  <option value="Computer Science">Computer Science</option>
                  <option value="Statistics">Statistics</option>
                  <option value="Calculus">Calculus</option>
                </select>
              </div>
              
              <div class="course-category">
                <h4 class="font-medium text-gray-700 mb-2">Other Subjects</h4>
                <input type="text" id="customSubject" placeholder="Enter custom subject" class="w-full p-2 border rounded-md">
              </div>
            </div>
          </div>

          <!-- Step 2: Assignment Type & Pricing -->
          <div class="bg-green-50 p-6 rounded-lg">
            <h3 class="text-lg font-semibold text-green-800 mb-4">
              <i class="fas fa-clipboard-list mr-2"></i>Step 2: Assignment Type & Pricing
            </h3>
            
            <!-- Writing Assignments -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-700 mb-3">Writing Assignments ($13 per page - ~250 words)</h4>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="essay" data-price="13" data-category="writing" class="mr-2">
                  <span>Essay</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="research-paper" data-price="13" data-category="writing" class="mr-2">
                  <span>Research Paper</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="discussion-post" data-price="13" data-category="writing" class="mr-2">
                  <span>Discussion Post</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="summary" data-price="13" data-category="writing" class="mr-2">
                  <span>Summary</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="book-review" data-price="13" data-category="writing" class="mr-2">
                  <span>Book Review</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="case-study" data-price="13" data-category="writing" class="mr-2">
                  <span>Case Study</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="lab-report" data-price="13" data-category="writing" class="mr-2">
                  <span>Lab Report</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="thesis" data-price="13" data-category="writing" class="mr-2">
                  <span>Thesis</span>
                </label>
              </div>
            </div>

            <!-- Rewriting Assignments -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-700 mb-3">Rewriting Services ($15 per page)</h4>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="rewrite-essay" data-price="15" data-category="rewriting" class="mr-2">
                  <span>Rewrite Essay</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="rewrite-paper" data-price="15" data-category="rewriting" class="mr-2">
                  <span>Rewrite Paper</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="paraphrase" data-price="15" data-category="rewriting" class="mr-2">
                  <span>Paraphrasing</span>
                </label>
              </div>
            </div>

            <!-- Correction Services -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-700 mb-3">Correction Services ($9 per page)</h4>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="proofreading" data-price="9" data-category="correction" class="mr-2">
                  <span>Proofreading</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="editing" data-price="9" data-category="correction" class="mr-2">
                  <span>Editing</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="grammar-check" data-price="9" data-category="correction" class="mr-2">
                  <span>Grammar Check</span>
                </label>
              </div>
            </div>

            <!-- Technical Assignments -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-700 mb-3">Technical Assignments (Custom Pricing)</h4>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="math-problems" data-price="custom" data-category="technical" class="mr-2">
                  <span>Math Problems</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="physics-problems" data-price="custom" data-category="technical" class="mr-2">
                  <span>Physics Problems</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="engineering-project" data-price="custom" data-category="technical" class="mr-2">
                  <span>Engineering Project</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="programming" data-price="custom" data-category="technical" class="mr-2">
                  <span>Programming</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="statistics" data-price="custom" data-category="technical" class="mr-2">
                  <span>Statistics</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="assignmentType" value="calculations" data-price="custom" data-category="technical" class="mr-2">
                  <span>Calculations</span>
                </label>
              </div>
            </div>

            <!-- Pages Input (for non-technical assignments) -->
            <div id="pagesSection" class="hidden">
              <label class="block text-sm font-medium text-gray-700 mb-2">Number of Pages</label>
              <input type="number" id="pages" min="1" max="100" class="w-full p-2 border rounded-md" placeholder="Enter number of pages">
              <p class="text-sm text-gray-500 mt-1">Each page is approximately 250 words</p>
            </div>

            <!-- Technical Assignment Note -->
            <div id="technicalNote" class="hidden bg-yellow-50 p-4 rounded-md">
              <p class="text-yellow-800">
                <i class="fas fa-info-circle mr-2"></i>
                Technical assignments require custom pricing. Please upload your materials for review and we'll provide a quote.
              </p>
            </div>
          </div>

          <!-- Step 3: Assignment Details -->
          <div class="bg-purple-50 p-6 rounded-lg">
            <h3 class="text-lg font-semibold text-purple-800 mb-4">
              <i class="fas fa-edit mr-2"></i>Step 3: Assignment Details
            </h3>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Assignment Title</label>
                <input type="text" id="assignmentTitle" class="w-full p-2 border rounded-md" placeholder="Enter assignment title" required>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Detailed Instructions</label>
                <textarea id="assignmentDescription" rows="6" class="w-full p-2 border rounded-md" placeholder="Provide detailed instructions for your assignment..." required></textarea>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Additional Requirements</label>
                <textarea id="additionalRequirements" rows="3" class="w-full p-2 border rounded-md" placeholder="Any specific formatting, citation style, or additional requirements..."></textarea>
              </div>
            </div>
          </div>

          <!-- Step 4: File Upload -->
          <div class="bg-orange-50 p-6 rounded-lg">
            <h3 class="text-lg font-semibold text-orange-800 mb-4">
              <i class="fas fa-upload mr-2"></i>Step 4: Upload Materials
            </h3>
            
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
              <input type="file" id="fileUpload" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.xlsx,.xls,.ppt,.pptx" class="hidden">
              <div onclick="document.getElementById('fileUpload').click()" class="cursor-pointer">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 mb-2">Click to upload files or drag and drop</p>
                <p class="text-sm text-gray-500">Supported formats: PDF, DOC, DOCX, TXT, JPG, PNG, XLSX, PPT, etc.</p>
              </div>
              <div id="fileList" class="mt-4 text-left"></div>
            </div>
          </div>

          <!-- Step 5: Timeline -->
          <div class="bg-gradient-to-r from-red-50 to-pink-50 p-6 rounded-lg border border-red-200">
            <h3 class="text-lg font-semibold text-red-800 mb-4">
              <i class="fas fa-clock mr-2"></i>Step 5: Timeline & Payment Info
            </h3>
            
            <!-- Important Notice -->
            <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                  <i class="fas fa-shield-alt text-green-500 text-xl"></i>
                </div>
                <div>
                  <h5 class="font-semibold text-green-800 mb-1">💳 Payment Protection</h5>
                  <p class="text-green-700 text-sm mb-2">
                    <strong>You're not charged until your order is reviewed and approved!</strong> 
                    Submit with confidence - payment only occurs after we confirm we can complete your assignment.
                  </p>
                  <div class="flex items-center space-x-2 text-blue-700 text-sm">
                    <i class="fas fa-info-circle"></i>
                    <span>⏰ Minimum 2-hour lead time required for quality assurance</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Due Date & Time *</label>
              <input type="datetime-local" id="dueDateTime" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
              <p class="text-xs text-gray-500 mt-1">Select when your assignment is due</p>
            </div>
            
            <div id="timeWarning" class="hidden mt-4 p-4 bg-red-100 border border-red-300 rounded-md">
              <div class="flex items-center space-x-3">
                <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                <div>
                  <p class="text-red-800 font-semibold">Cannot Submit - Too Close to Deadline!</p>
                  <p class="text-red-700 text-sm mt-1">
                    We need at least 2 hours to ensure quality work. Please select a due date at least 2 hours from now.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Price Calculator -->
          <div class="bg-gray-50 p-6 rounded-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
              <i class="fas fa-calculator mr-2"></i>Price Calculator
            </h3>
            
            <div id="priceBreakdown" class="space-y-2">
              <div class="flex justify-between">
                <span>Assignment Type:</span>
                <span id="selectedType">-</span>
              </div>
              <div class="flex justify-between">
                <span>Pages:</span>
                <span id="selectedPages">-</span>
              </div>
              <div class="flex justify-between">
                <span>Price per page:</span>
                <span id="pricePerPage">-</span>
              </div>
              <hr class="my-2">
              <div class="flex justify-between font-bold text-lg">
                <span>Total Cost:</span>
                <span id="totalCost">$0.00</span>
              </div>
            </div>
            
            <div id="customPriceNote" class="hidden mt-4 p-3 bg-blue-100 border border-blue-300 rounded-md">
              <p class="text-blue-800">
                <i class="fas fa-info-circle mr-2"></i>
                This is a technical assignment. Upload your materials and we'll provide a custom quote within 1 hour.
              </p>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="flex space-x-4">
            <button type="button" onclick="closeOrderModal()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-md hover:bg-gray-600 transition duration-200">
              <i class="fas fa-times mr-2"></i>Cancel
            </button>
            <button type="submit" id="submitOrderBtn" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-md hover:bg-blue-700 transition duration-200">
              <i class="fas fa-shopping-cart mr-2"></i><span class="btn-text">Submit Order</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Section Navigation
function showSection(sectionId) {
  document.querySelectorAll("main > section").forEach((section) => section.classList.add("hidden"));
  document.getElementById(sectionId).classList.remove("hidden");

  document.querySelectorAll(".icon-sidebar a").forEach((link) => link.classList.remove("active"));
  document.querySelector(`.icon-sidebar a[onclick="showSection('${sectionId}')"]`).classList.add("active");
}
function goBack() {
  history.back(); // Navigates to the previous page
}

function updateHeader(sectionName) {
  // Update Mobile & Large screen headers
  document.getElementById("section-title-mobile").textContent = sectionName;
  document.getElementById("section-title-large").textContent = sectionName;
}

// Example: Call this when switching sections
// updateHeader("Messages");

  </script>

<script>
// Check authentication on page load
window.addEventListener('DOMContentLoaded', function() {
    const userId = localStorage.getItem("userId");
    if (!userId) {
        alert("Please log in to access the dashboard");
        window.location.href = 'index.html';
        return;
    }
    
    // Load user profile
    fetchProfile();
    
    // Update header with user name
    const userName = localStorage.getItem("userName");
    if (userName) {
        updateHeader(`Welcome, ${userName}`);
    }
});

const studentId = localStorage.getItem("userId"); // Ensure user ID is stored
const API_BASE = "https://meme-s6lb.onrender.com";
const defaultAvatar = "https://via.placeholder.com/150"; // Default avatar

// ✅ Fetch and Display Profile Information
async function fetchProfile() {
    if (!studentId) {
        console.error("No studentId found in localStorage.");
        window.location.href = 'index.html';
        return;
    }

    try {
        const response = await fetch(`${API_BASE}/user/${studentId}`);
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.message || 'Failed to fetch profile');
        }

        const data = result.user;
        if (!data) {
            console.error("No profile data received.");
            return;
        }

        // ✅ Update Profile Details (supports view and inline-edit modes)
        const setTextOrValue = (el, text) => {
          if (!el) return;
          if ('value' in el) { el.value = text; } else { el.textContent = text; }
        };
        setTextOrValue(document.getElementById('user-name') || document.getElementById('inline-name'), data.name || 'Unknown');
        setTextOrValue(document.getElementById('user-email') || document.getElementById('inline-email'), data.email || 'No email provided');
        try { localStorage.setItem('userEmail', data.email || ''); } catch (e) {}
        const balance = Number(data.balance || 0);
        const walletEl = document.getElementById('wallet-balance');
        if (walletEl) walletEl.textContent = `$${balance.toFixed(2)}`;
        // Also update the payments section balance
        const userBalanceElement = document.getElementById('userBalance');
        if (userBalanceElement) {
            userBalanceElement.textContent = `$${balance.toFixed(2)}`;
        }
        
        // Update user name in payments section
        const userNameElement = document.getElementById('userName');
        if (userNameElement) {
            userNameElement.textContent = data.name || 'User';
        }
        // Bio
        setTextOrValue(document.getElementById('user-bio') || document.getElementById('inline-bio'), data.bio || 'Welcome to EssayMe! Complete your profile to get started.');
        
        // Phone
        const phoneTarget = document.getElementById('user-phone') || document.getElementById('inline-phone');
        if (phoneTarget) setTextOrValue(phoneTarget, data.phone || 'Not set');

        // Social links removed from UI; no update needed

        // ✅ Update Profile Image
        const profileImageUrl = data.profileImage || defaultAvatar;
        document.getElementById("profile-picture").src = profileImageUrl;
        document.getElementById("profile-picture-lg").src = profileImageUrl;
        document.getElementById("edit-profile-picture").src = profileImageUrl;

        // Payments profile image
        const paymentsImg = document.getElementById('payments-profile-image');
        if (paymentsImg) paymentsImg.src = profileImageUrl;
        
        // Update header icon: show image if available; otherwise show initials
        const iconImg = document.getElementById("profile-icon-image");
        const initialsEl = document.getElementById("profile-initials");
        if (iconImg && initialsEl) {
          if (profileImageUrl && profileImageUrl !== defaultAvatar) {
            iconImg.src = profileImageUrl;
            iconImg.classList.remove('hidden');
            initialsEl.classList.add('hidden');
          } else {
            iconImg.classList.add('hidden');
            initialsEl.classList.remove('hidden');
          }
        }
        
        // Update profile initials (guard if header element not present)
        const initials = data.name ? data.name.split(' ').map(n => n[0]).join('').toUpperCase() : '??';
        const initialsNode = document.getElementById('profile-initials');
        if (initialsNode) initialsNode.textContent = initials;
        
    } catch (error) {
        console.error("Profile Fetch Error:", error.message);
        alert("Failed to load profile. Please try logging in again.");
    }
}

// ✅ Utility function: Fetch data from an API endpoint
async function fetchData(endpoint, method = "GET", body = null) {
    const headers = { "Content-Type": "application/json" };
    const options = { method, headers };
    if (body) options.body = JSON.stringify(body);

    try {
        const response = await fetch(`${API_BASE}/${endpoint}`, options);
        if (!response.ok) throw new Error(`Failed to fetch ${endpoint}: ${response.statusText}`);
        return await response.json();
    } catch (error) {
        console.error("API Fetch Error:", error.message);
    }
}

// ✅ Open/Edit Toggle: Edit Profile button becomes Save Profile on second click
function enableEditProfile() {
    const card = document.getElementById("profile-card");
    const actions = card && (card.nextElementSibling || document.querySelector('#profile .flex.flex-col.sm\\:flex-row'));
    const editBtn = actions && actions.querySelector('button[onclick="enableEditProfile()"]');
    if (!card || !actions || !editBtn) return;

    // If already in editing mode, clicking again saves
    if (editBtn.dataset.mode === 'saving') {
      saveInlineProfile();
      return;
    }

    // First click: switch to inline edit mode
    const nameEl = document.getElementById("user-name");
    const emailEl = document.getElementById("user-email");
    const bioEl = document.getElementById("user-bio");
    const phoneEl = document.getElementById("user-phone");
    if (!nameEl || !emailEl || !bioEl) return;

    if (!document.getElementById('inline-name')) {
      const current = nameEl.textContent.trim();
      nameEl.outerHTML = `<input id="inline-name" type="text" class="inline-edit-field text-3xl font-semibold text-gray-800 w-full border rounded-lg p-2" value="${current}" placeholder="Enter your full name">`;
    }
    if (!document.getElementById('inline-email')) {
      const current = (emailEl.textContent||'').trim();
      emailEl.outerHTML = `<input id="inline-email" type="email" class="inline-edit-field text-md text-blue-600 underline w-full border rounded-lg p-2 mt-1" value="${current}" placeholder="Enter your email address">`;
    }
    if (!document.getElementById('inline-phone')) {
      const phoneCurrent = (phoneEl && phoneEl.textContent && phoneEl.textContent !== 'Not set') ? phoneEl.textContent.trim() : '';
      const phoneBlock = document.createElement('div');
      phoneBlock.innerHTML = `<input id="inline-phone" type="text" class="inline-edit-field w-full border rounded-lg p-2 mt-2" placeholder="e.g. +1 555 123 4567" value="${phoneCurrent}">`;
      const userInfoContainer = card.querySelector('.flex-1.text-left.w-full');
      const bioBlock = userInfoContainer && userInfoContainer.querySelector('div.mt-4');
      (userInfoContainer && bioBlock) && userInfoContainer.insertBefore(phoneBlock, bioBlock);
    }
    if (!document.getElementById('inline-bio')) {
      const current = bioEl.textContent.trim();
      bioEl.outerHTML = `<textarea id="inline-bio" rows="3" class="inline-edit-field w-full border rounded-lg p-3 shadow-sm" placeholder="Tell us about yourself">${current}</textarea>`;
    }

    // Toggle button to Save mode
    editBtn.textContent = 'Save Profile';
    editBtn.dataset.mode = 'saving';
}

// ✅ Cancel Edit (Return to Profile Overview)
function cancelEdit() {
    // Legacy full-screen editor support (kept, but we use inline now)
    document.getElementById("edit-profile-form")?.classList.add("hidden");
    document.getElementById("profile-card")?.classList.remove("hidden");
}

// Inline: cancel and restore view state
function cancelInlineEdit() {
  // reload data to restore original DOM
  fetchProfile();
  const actions = document.querySelector('#profile .flex.flex-col.sm\\:flex-row') || document.getElementById('profile')?.querySelector('.flex.flex-col');
  const editBtn = actions && actions.querySelector('button[onclick="enableEditProfile()"]');
  if (editBtn) {
    editBtn.textContent = 'Edit Profile';
    editBtn.dataset.mode = '';
    editBtn.classList.remove('hidden');
  }
}

async function saveInlineProfile() {
  if (!studentId) return alert('User not logged in!');
  const name = document.getElementById('inline-name')?.value || '';
  const email = document.getElementById('inline-email')?.value || '';
  const bio = document.getElementById('inline-bio')?.value || '';
  const phone = document.getElementById('inline-phone')?.value || '';

  try {
    const res = await fetch(`${API_BASE}/update-account`, {
      method: 'POST',
      body: (() => {
        const fd = new FormData();
        fd.append('userId', studentId);
        fd.append('name', name);
        fd.append('email', email);
        fd.append('bio', bio);
        fd.append('phone', phone);
        return fd;
      })()
    });
    if (!res.ok) throw new Error('Failed to update profile');
    await fetchProfile();
    cancelInlineEdit();
  } catch (e) {
    console.error('Profile Update Error:', e);
    alert('Failed to update profile');
  }
}

// ✅ Preview Profile Picture When Selected
function updateProfilePicture(event) {
    const input = event?.target || document.getElementById('profile-upload');
    const file = input && input.files && input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const url = e.target.result;
        ['edit-profile-picture','profile-picture','profile-picture-lg'].forEach(id => {
            const img = document.getElementById(id);
            if (img) img.src = url;
        });
    };
    reader.readAsDataURL(file);
}

document.getElementById('profile-upload')?.addEventListener('change', async (e) => {
  const placeholder = document.getElementById('profile-upload-placeholder');
  if (placeholder) placeholder.textContent = 'Uploading...';
  updateProfilePicture(e);
  // Try uploading immediately to backend
  const file = e.target?.files?.[0];
  if (file && studentId) {
    try {
      const fd = new FormData();
      fd.append('userId', studentId);
      fd.append('profileImage', file);
      await fetch(`${API_BASE}/update-account`, { method: 'POST', body: fd });
      if (placeholder) placeholder.textContent = 'Uploaded';
      setTimeout(() => { if (placeholder) placeholder.textContent = ''; }, 1500);
    } catch (_) {
      if (placeholder) placeholder.textContent = 'Upload failed';
      setTimeout(() => { if (placeholder) placeholder.textContent = ''; }, 2000);
    }
  }
});

// ✅ Save Updated Profile Information
async function saveProfile() {
    if (!studentId) return alert("User not logged in!");

    const formData = new FormData();
    formData.append("userId", studentId);
    formData.append("name", document.getElementById("edit-username").value);
    formData.append("bio", document.getElementById("edit-bio").value);
    formData.append("phone", document.getElementById("edit-phone").value || '');

    const profileImage = document.getElementById("profile-upload").files[0];
    if (profileImage) {
        formData.append("profileImage", profileImage);
    }

    try {
        const response = await fetch(`${API_BASE}/update-account`, { method: "POST", body: formData });
        if (!response.ok) throw new Error("Failed to update profile");

        alert("Profile updated successfully!");
        fetchProfile(); // Refresh profile data
        cancelEdit(); // Return to profile overview
    } catch (error) {
        console.error("Profile Update Error:", error.message);
    }
}


  function downloadAllCompleted(assignmentId) {
    // For now, just open each file in a new tab; zipping can be added later server-side
    const assignment = (window._lastAssignments || []).find(a => a.id === assignmentId);
    if (!assignment || !Array.isArray(assignment.completedFiles)) return;
    assignment.completedFiles.forEach(f => {
  const a = document.createElement('a');
  a.href = `${API_BASE}/file/${encodeURIComponent(f.filename)}`;
  a.download = '';
  document.body.appendChild(a);
  a.click();
  a.remove();
});
  }

  async function requestRefund(orderId, amount) {
    if (!confirm(`Request refund of $${Number(amount).toFixed(2)} for this order?`)) return;
    try {
      const res = await fetch(`${API_BASE}/payments/request-refund`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: studentId, orderId, amount, reason: 'Student requested refund' })
      });
      const result = await res.json();
      if (result.success) {
        alert('Refund requested. We will notify you once processed.');
      } else {
        alert(result.message || 'Failed to request refund');
      }
    } catch (e) {
      console.error('Refund request error:', e);
      alert('Error requesting refund');
    }
  }

  // Fetch and Display Assignments
  async function fetchHomework() {
    try {
      const response = await fetch(`${API_BASE}/orders/${studentId}`);
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.message || 'Failed to fetch orders');
      }
      
      const assignments = result.orders;
      const assignmentsContainer = document.getElementById("assignments-container");
      
      if (!assignments || assignments.length === 0) {
        assignmentsContainer.innerHTML = `
          <div class="col-span-full text-center py-8">
            <div class="bg-gray-100 rounded-lg p-8">
              <i class="fas fa-book text-4xl text-gray-400 mb-4"></i>
              <h3 class="text-lg font-semibold text-gray-600 mb-2">No Orders Yet</h3>
              <p class="text-gray-500 mb-4">Your orders will appear here once you place them.</p>
              <a href="place-order.html" class="inline-block bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                <i class="fas fa-plus mr-2"></i>Place Your First Order
              </a>
            </div>
          </div>
        `;
        return;
      }
  
      // keep a copy for helpers like downloadAllCompleted
      window._lastAssignments = assignments;

      assignmentsContainer.innerHTML = assignments
        .map(
          (assignment) => `
            <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-transform duration-300 hover:scale-[1.02] sm:hover:scale-100">
              <div class="flex justify-between items-start mb-3">
                <h2 class="text-lg font-semibold text-gray-800">${assignment.assignmentTitle || assignment.subject + ' - ' + assignment.orderType}</h2>
                <span class="${getStatusClass(assignment.status)} text-sm px-3 py-1 rounded-full">${getStatusText(assignment.status)}</span>
              </div>
              
              <div class="space-y-2 text-sm text-gray-600">
                <p><strong>Subject:</strong> ${assignment.subject}</p>
                <p><strong>Type:</strong> ${assignment.orderType}</p>
                ${assignment.category !== 'technical' ? `<p><strong>Pages:</strong> ${assignment.pages}</p>` : ''}
                ${assignment.totalCost > 0 ? `<p><strong>Cost:</strong> $${assignment.totalCost.toFixed(2)}</p>` : ''}
                <p><strong>Due:</strong> ${new Date(assignment.deadline).toLocaleDateString()} at ${new Date(assignment.deadline).toLocaleTimeString()}</p>
                <p><strong>Ordered:</strong> ${new Date(assignment.createdAt).toLocaleDateString()}</p>
              </div>
              
              <div class="mt-3">
                <p class="text-sm text-gray-700"><strong>Description:</strong></p>
                <p class="text-sm text-gray-600 mt-1">${assignment.description.length > 100 ? assignment.description.substring(0, 100) + '...' : assignment.description}</p>
              </div>
              
              <!-- Progress Bar -->
              <div class="mt-4 bg-gray-200 rounded-full h-2.5">
                <div class="${getProgressBarClass(assignment.status)} h-2.5 rounded-full ${getProgressWidth(assignment.status)}"></div> 
              </div>
              
              <!-- Status-specific actions -->
              ${getStatusActions(assignment)}
            </div>`
        )
        .join("");
    } catch (error) {
      console.error("Failed to fetch homework:", error.message);
      document.getElementById("assignments-container").innerHTML = `
        <div class="col-span-full text-center py-8">
          <div class="bg-red-100 rounded-lg p-8">
            <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
            <h3 class="text-lg font-semibold text-red-600 mb-2">Error Loading Assignments</h3>
            <p class="text-red-500">Please try refreshing the page.</p>
          </div>
        </div>
      `;
    }
  }
  
  // Helper function to get status class
  function getStatusClass(status) {
    switch(status.toLowerCase()) {
      case 'pending': return 'bg-yellow-100 text-yellow-800';
      case 'under-review': return 'bg-purple-100 text-purple-800';
      case 'checking-balance': return 'bg-orange-100 text-orange-800';
      case 'assigned': return 'bg-blue-100 text-blue-800';
      case 'in-progress': return 'bg-indigo-100 text-indigo-800';
      case 'completed': return 'bg-green-100 text-green-800';
      case 'cancelled': return 'bg-red-100 text-red-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  }
  
  // Helper function to get status text
  function getStatusText(status) {
    switch(status.toLowerCase()) {
      case 'pending': return 'Pending';
      case 'under-review': return 'Under Review';
      case 'checking-balance': return 'Checking Balance';
      case 'assigned': return 'Assigned';
      case 'in-progress': return 'In Progress';
      case 'completed': return 'Completed';
      case 'cancelled': return 'Cancelled';
      default: return status;
    }
  }
  
  // Helper function to get status actions
  function getStatusActions(assignment) {
    switch(assignment.status.toLowerCase()) {
      case 'under-review':
        return `<div class="mt-3 p-3 bg-purple-50 rounded-md">
          <p class="text-sm text-purple-800">
            <i class="fas fa-clock mr-2"></i>
            Your assignment is being reviewed. You'll receive a quote within 1 hour.
          </p>
        </div>`;
      
      case 'checking-balance':
        return `<div class="mt-3 p-3 bg-orange-50 rounded-md">
          <p class="text-sm text-orange-800">
            <i class="fas fa-credit-card mr-2"></i>
            Please ensure your account balance covers $${assignment.totalCost.toFixed(2)} for this assignment.
          </p>
          <button onclick="showSection('payments')" class="mt-2 bg-orange-600 text-white px-4 py-2 rounded text-sm hover:bg-orange-700">
            Add Funds
          </button>
        </div>`;
      
      case 'completed':
        return `<div class="mt-3 p-3 bg-green-50 rounded-md">
          <p class="text-sm text-green-800">
            <i class="fas fa-check-circle mr-2"></i>
            Assignment completed successfully!
          </p>
          ${Array.isArray(assignment.completedFiles) && assignment.completedFiles.length > 0 ? `
            <div class="mt-2 space-y-2">
              ${assignment.completedFiles.map(f => `
                <div class="flex items-center space-x-2 bg-white p-2 rounded">
                  <i class="fas fa-file text-green-600"></i>
                  <span class="text-sm">${f.originalName || f.filename}</span>
                  <a href="${API_BASE}/file/${encodeURIComponent(f.filename)}" download class="text-blue-600 hover:text-blue-800 text-sm">
                    <i class="fas fa-download"></i>
                  </a>
                </div>
              `).join('')}
            </div>
          ` : `<p class="text-xs text-green-700 mt-2">Files will appear here when available.</p>`}
          <div class="mt-3 flex items-center space-x-2">
            <button class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700" onclick="downloadAllCompleted('${assignment.id}')">
              <i class="fas fa-download mr-2"></i>Download All
            </button>
            <button class="bg-red-600 text-white px-4 py-2 rounded text-sm hover:bg-red-700" onclick="requestRefund('${assignment.id}', ${Number(assignment.totalCost || 0)})">
              <i class="fas fa-flag mr-2"></i>Request Refund
            </button>
          </div>
        </div>`;
      
      default:
        return '';
    }
  }
  
  // Helper function to get progress bar class
  function getProgressBarClass(status) {
    switch(status.toLowerCase()) {
      case 'pending': return 'bg-yellow-500';
      case 'under-review': return 'bg-purple-500';
      case 'checking-balance': return 'bg-orange-500';
      case 'assigned': return 'bg-blue-500';
      case 'in-progress': return 'bg-indigo-500';
      case 'completed': return 'bg-green-500';
      case 'cancelled': return 'bg-red-500';
      default: return 'bg-gray-500';
    }
  }
  
  // Helper function to get progress width
  function getProgressWidth(status) {
    switch(status.toLowerCase()) {
      case 'pending': return 'w-[15%]';
      case 'under-review': return 'w-[25%]';
      case 'checking-balance': return 'w-[40%]';
      case 'assigned': return 'w-[60%]';
      case 'in-progress': return 'w-[80%]';
      case 'completed': return 'w-full';
      case 'cancelled': return 'w-[10%]';
      default: return 'w-[5%]';
    }
  }
  
  // Fetch and Display Chat Messages
// Removed old fetchMessages and openChat functions - using SSE-based messaging system
// Function to format message HTML
function createMessageHTML(message) {
  return `
    <div class="chat-message ${message.sender === "Student" ? "student" : "tutor"}">
      <div class="chat-bubble ${message.sender === "Student" ? "bg-blue-500 text-white" : "bg-gray-200 text-black"} p-3 rounded-lg shadow-md">
        <strong>${message.sender}</strong>: ${message.content}
        <br><small class="text-xs text-black-500">${message.timestamp}</small>
      </div>
    </div>`;
}

document.getElementById("send-message").addEventListener("click", sendMessage);
document.getElementById("chat-box").addEventListener("input", toggleSendButton);

function toggleSendButton() {
  const chatBox = document.getElementById("chat-box");
  const sendButton = document.getElementById("send-message");

  if (chatBox.value.trim()) {
    sendButton.classList.remove("bg-gray-400", "cursor-not-allowed");
    sendButton.classList.add("bg-blue-500", "hover:bg-blue-400");
    sendButton.disabled = false;
  } else {
    sendButton.classList.remove("bg-blue-500", "hover:bg-blue-400");
    sendButton.classList.add("bg-gray-400", "cursor-not-allowed");
    sendButton.disabled = true;
  }
}

// Removed duplicate sendMessage function that was causing triple message display

  
  // Section Navigation
  function showSection(sectionId) {
    // Switch visible section
    document.querySelectorAll("main > section").forEach((section) => section.classList.add("hidden"));
    document.getElementById(sectionId).classList.remove("hidden");

    // Update active state in sidebar
    document.querySelectorAll(".icon-sidebar a").forEach((link) => link.classList.remove("active"));
    document.querySelector(`.icon-sidebar a[onclick="showSection('${sectionId}')"]`)?.classList.add("active");

    // Special handling for messages section
    if (sectionId === 'messages') {
      // Always show assignment selection view first
      switchToAssignmentView();
      // If user navigates to Messages and an assignment is active, mark unread as read
      if (activeAssignment && activeAssignment.id) {
        clearStudentUnread(activeAssignment.id);
      }
    }
  }
  
  // Initialize Dashboard
  let activeAssignment = null; // { id, title, assignedTutor }
  let loggedInStudentId = localStorage.getItem('userId') || '';

  // SSE realtime for student
  let studentEventSource = null;
  let studentSeenMessageIds = new Set();
  function updateStudentSidebarBadge(){
    const total = Array.from(window.studentUnread?.values()||[]).reduce((a,b)=>a+b,0);
    
    // Update desktop sidebar badge
    const el = document.getElementById('student-chat-badge');
    if(el) {
      if(total>0){ el.textContent = String(total); el.classList.remove('hidden'); }
      else { el.classList.add('hidden'); }
    }
    
    // Update mobile bottom navigation badge
    const mobileEl = document.getElementById('student-chat-badge-mobile');
    if(mobileEl) {
      if(total>0){ mobileEl.textContent = String(total); mobileEl.classList.remove('hidden'); }
      else { mobileEl.classList.add('hidden'); }
    }
  }
  function updateStudentListBadge(assignmentId){
    const btn = document.querySelector(`#assignment-chat-list button[data-id="${CSS.escape(String(assignmentId))}"]`);
    if(!btn) return;
    const badge = btn.querySelector('.assignment-unread-badge');
    const count = window.studentUnread?.get(String(assignmentId))||0;
    if(count>0){ badge.textContent = String(count); badge.classList.remove('hidden'); }
    else { badge.classList.add('hidden'); }
  }

  // LocalStorage helpers for last-read timestamps per assignment
  function getStudentLastReadMap(){
    try{ return JSON.parse(localStorage.getItem('studentLastRead')||'{}')||{}; }catch(_){ return {}; }
  }
  function setStudentLastRead(assignmentId, ts){
    const map = getStudentLastReadMap();
    map[String(assignmentId)] = ts || Date.now();
    localStorage.setItem('studentLastRead', JSON.stringify(map));
  }
  function getStudentLastRead(assignmentId){
    const map = getStudentLastReadMap();
    const v = map[String(assignmentId)];
    return typeof v === 'number' ? v : 0;
  }

  function incrementStudentUnread(assignmentId){
    const id = String(assignmentId);
    // If messages section visible and this assignment is active, don't count
    const messagesVisible = !document.getElementById('messages').classList.contains('hidden');
    if(messagesVisible && activeAssignment && String(activeAssignment.id)===id) return;
    const current = window.studentUnread.get(id)||0;
    window.studentUnread.set(id, current+1);
    updateStudentListBadge(id);
    updateStudentSidebarBadge();
  }
  function clearStudentUnread(assignmentId){
    if(!assignmentId) return;
    const id = String(assignmentId);
    // Update client-side last read timestamp
    setStudentLastRead(id, Date.now());
    if(window.studentUnread.has(id)) window.studentUnread.set(id, 0);
    updateStudentListBadge(id);
    updateStudentSidebarBadge();
  }

  // Poll server to compute unread counts for all assignments using last-read timestamps
  async function refreshUnreadCounts(){
    try{
      const list = document.getElementById('assignment-chat-list');
      if(!list) return;
      const buttons = Array.from(list.querySelectorAll('button[data-id]'));
      if(buttons.length===0) return;
      // Fetch messages for each assignment and compute tutor messages after last-read
      await Promise.all(buttons.map(async (btn)=>{
        const id = String(btn.dataset.id);
        try{
          const res = await fetch(`https://meme-s6lb.onrender.com/messages?assignmentId=${encodeURIComponent(id)}`);
          const data = await res.json();
          if(!data.success) return;
          const lastRead = getStudentLastRead(id);
          const count = (data.messages||[]).filter(m=> m.sender==='tutor' && new Date(m.createdAt).getTime() > lastRead).length;
          window.studentUnread.set(id, count);
          updateStudentListBadge(id);
        }catch(_){ /* ignore per-assignment failure */ }
      }));
      updateStudentSidebarBadge();
    }catch(_){ /* ignore */ }
  }

  function startStudentSSE(){
    if (studentEventSource) { try{ studentEventSource.close(); }catch(_){} studentEventSource = null; }
    if (!activeAssignment) return;
    // Don't reset studentSeenMessageIds here - it's reset when switching assignments and populated by loadMessages
    const url = `https://meme-s6lb.onrender.com/messages/stream?assignmentId=${encodeURIComponent(activeAssignment.id)}`;
    studentEventSource = new EventSource(url);
    studentEventSource.onmessage = (evt)=>{
      try {
        const data = JSON.parse(evt.data);
        if (data?.type === 'message' && data.message) {
          const m = data.message;
          if (String(m.assignmentId) !== String(activeAssignment.id)) return;
          if (m._id && studentSeenMessageIds.has(m._id)) return;
          if (m._id) studentSeenMessageIds.add(m._id);
          const sender = m.sender === 'student' ? 'Student' : 'Tutor';
          appendMessageToChat({ sender, content: m.content, timestamp: new Date(m.createdAt).toLocaleString() });
          if(sender === 'Tutor'){
            incrementStudentUnread(m.assignmentId);
            document.getElementById('student-new-message-audio')?.play().catch(()=>{});
          }
        }
      } catch(_){ }
    };
  }
  function restartStudentSSE(){ if(studentEventSource){ try{ studentEventSource.close(); }catch(_){} studentEventSource=null; } startStudentSSE(); }

  // View switching functions
  function switchToChatView() {
    const assignmentView = document.getElementById('assignment-selection-view');
    const chatView = document.getElementById('chat-view');
    
    // Add fade out animation to assignment view
    assignmentView.style.opacity = '0';
    assignmentView.style.transform = 'translateX(-20px)';
    
    setTimeout(() => {
      assignmentView.classList.add('hidden');
      chatView.classList.remove('hidden');
      
      // Add fade in animation to chat view
      chatView.style.opacity = '0';
      chatView.style.transform = 'translateX(20px)';
      
      setTimeout(() => {
        chatView.style.opacity = '1';
        chatView.style.transform = 'translateX(0)';
      }, 50);
    }, 250);
  }

  function switchToAssignmentView() {
    const assignmentView = document.getElementById('assignment-selection-view');
    const chatView = document.getElementById('chat-view');
    
    // Add fade out animation to chat view
    chatView.style.opacity = '0';
    chatView.style.transform = 'translateX(20px)';
    
    setTimeout(() => {
      chatView.classList.add('hidden');
      assignmentView.classList.remove('hidden');
      
      // Add fade in animation to assignment view
      assignmentView.style.opacity = '0';
      assignmentView.style.transform = 'translateX(-20px)';
      
      setTimeout(() => {
        assignmentView.style.opacity = '1';
        assignmentView.style.transform = 'translateX(0)';
      }, 50);
    }, 250);
    
    // Clear active assignment
    activeAssignment = null;
    document.getElementById('active-assignment-title').textContent = 'None';
    toggleSendButton();
    
    // Stop SSE connection
    if(studentEventSource){ 
      try{ studentEventSource.close(); }catch(_){} 
      studentEventSource=null; 
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("send-message").addEventListener("click", sendMessage);
    document.getElementById("chat-box").addEventListener("input", toggleSendButton);
    toggleSendButton();
    document.getElementById("refresh-assignments")?.addEventListener("click", loadAssignmentList);
    document.getElementById("back-to-assignments")?.addEventListener("click", switchToAssignmentView);
    // init unread map for student
    window.studentUnread = new Map(); // assignmentId -> count
    fetchProfile();
    loadAssignmentList();
  });

  async function loadAssignmentList(){
    const list = document.getElementById('assignment-chat-list');
    list.innerHTML = '<div class="text-gray-500 text-sm">Loading...</div>';
    try{
      const res = await fetch(`https://meme-s6lb.onrender.com/student/assignments?userId=${encodeURIComponent(loggedInStudentId)}`);
      const data = await res.json();
      if(!data.success){ list.innerHTML = '<div class="text-red-600 text-sm">Failed to load assignments</div>'; return; }
      const items = (data.assignments||[]).map(a=>{
        const t = a.title || 'Untitled';
        const s = a.status || '';
        return `<button class="assignment-card text-left p-4 border border-gray-200 rounded-lg hover:bg-gray-50 relative bg-white shadow-sm" data-id="${a.id}" data-title="${t}" data-tutor="${a.assignedTutor||''}">
          <div class="font-semibold text-gray-800">${t}</div>
          <div class="text-sm text-gray-500 mt-1">${a.subject||''} • ${s}</div>
          <span class="assignment-unread-badge bg-red-600 text-white text-[10px] leading-none rounded-full px-1.5 py-0.5 hidden">0</span>
        </button>`;
      }).join('');
      list.innerHTML = items || '<div class="text-gray-500 text-sm">No assignments yet.</div>';
      // attach click handlers and apply unread counts
      list.querySelectorAll('button[data-id]')?.forEach(btn=>{
        const id = String(btn.dataset.id);
        const badge = btn.querySelector('.assignment-unread-badge');
        const count = window.studentUnread?.get(id)||0;
        if(count>0){ badge.textContent = String(count); badge.classList.remove('hidden'); }
        else { badge.classList.add('hidden'); }
        btn.addEventListener('click', ()=>{
          activeAssignment = { id: btn.dataset.id, title: btn.dataset.title, assignedTutor: btn.dataset.tutor };
          studentSeenMessageIds = new Set(); // reset dedup cache when switching assignment
          document.getElementById('active-assignment-title').textContent = activeAssignment.title;
          // opening marks as read
          clearStudentUnread(activeAssignment.id);
          toggleSendButton();
          loadMessages();
          restartStudentSSE();
          // Switch to chat view with animation
          switchToChatView();
        });
      });
      // After rendering, refresh unread counts once to ensure badges appear
      refreshUnreadCounts();
      updateStudentSidebarBadge();
    }catch(e){ list.innerHTML = '<div class="text-red-600 text-sm">Network error</div>'; }
  }

  async function loadMessages(){
    const history = document.getElementById('chat-history');
    if(!activeAssignment){ history.innerHTML = '<div class="text-gray-500 text-sm">Select an assignment to start chatting.</div>'; return; }
    history.innerHTML = '<div class="text-gray-500 text-sm">Loading messages...</div>';
    try{
      const res = await fetch(`https://meme-s6lb.onrender.com/messages?assignmentId=${encodeURIComponent(activeAssignment.id)}`);
      const data = await res.json();
      if(!data.success){ history.innerHTML = '<div class="text-red-600 text-sm">Failed to load messages</div>'; return; }
      history.innerHTML = '';
      (data.messages||[]).forEach(m=> {
        // Add message ID to seen set to prevent SSE duplicates
        if (m._id) studentSeenMessageIds.add(m._id);
        appendMessageToChat({ sender: m.sender === 'student' ? 'Student' : 'Tutor', content: m.content, timestamp: new Date(m.createdAt).toLocaleString() }, false);
      });
      history.scrollTop = history.scrollHeight;
      // opening chat means read
      clearStudentUnread(activeAssignment.id);
    }catch(e){ history.innerHTML = '<div class="text-red-600 text-sm">Network error</div>'; }
  }

  function appendMessageToChat(message, append=true){
    const chatHistory = document.getElementById("chat-history");
    if (!chatHistory) return;

    const messageDiv = document.createElement('div');
    messageDiv.className = message.sender === 'Student' ? 'student-message' : 'tutor-message';
    
    const messageContent = `
      <div class="flex items-start space-x-2">
        <div class="flex-1">
          <div class="font-semibold text-xs mb-1 opacity-75">${message.sender}</div>
          <div>${message.content}</div>
          <div class="text-xs opacity-60 mt-1">${message.timestamp}</div>
        </div>
      </div>
    `;
    
    messageDiv.innerHTML = messageContent;
    chatHistory.appendChild(messageDiv);
    if(append!==false) chatHistory.scrollTop = chatHistory.scrollHeight;
  }

  async function sendMessage(){
    const content = document.getElementById('chat-box').value.trim();
    if(!content || !activeAssignment){ return; }
    try{
      const tutorId = activeAssignment.assignedTutor || '';
      const res = await fetch('https://meme-s6lb.onrender.com/messages', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ assignmentId: activeAssignment.id, studentId: loggedInStudentId, tutorId, sender: 'student', content }) });
      const data = await res.json();
      if(!data.success){ console.error('Failed to send'); }
      // play send sound on successful post
      document.getElementById('student-send-audio')?.play().catch(()=>{});
    }catch(e){ console.error('Network error'); }
    finally {
      document.getElementById('chat-box').value='';
      toggleSendButton();
    }
  }

  function toggleSendButton(){
    const chatBox = document.getElementById('chat-box');
    const sendButton = document.getElementById('send-message');
    const canSend = !!chatBox.value.trim() && !!activeAssignment; // allow sending even if tutor not yet assigned
    sendButton.disabled = !canSend;
    if(canSend){ sendButton.classList.remove("bg-gray-400","cursor-not-allowed"); sendButton.classList.add("bg-blue-500","hover:bg-blue-400"); }
    else { sendButton.classList.add("bg-gray-400","cursor-not-allowed"); sendButton.classList.remove("bg-blue-500","hover:bg-blue-400"); }
  }

// Open the phone number popup
function openPhonePopup() {
  document.getElementById("phone-popup").classList.remove("hidden");
}

// Close the phone number popup
function closePhonePopup() {
  document.getElementById("phone-popup").classList.add("hidden");
}

// Save the phone number and update the input field
function savePhoneNumber() {
  const countryCode = document.getElementById("country-code").value;
  const phoneNumber = document.getElementById("new-phone-number").value;
  const fullPhoneNumber = countryCode + " " + phoneNumber;

  // Update the phone number input field with the selected number
  document.getElementById("phone-number").value = fullPhoneNumber;

  // Close the popup
  closePhonePopup();
}


// Open Password Update Popup
function openPasswordPopup() {
  document.getElementById("password-popup").classList.remove("hidden");
}

// Close Password Popup
function closePasswordPopup() {
  document.getElementById("password-popup").classList.add("hidden");
}

// Open Profile Picture Popup
function openProfilePicturePopup() {
  document.getElementById("profile-picture-popup").classList.remove("hidden");
}

// Close Profile Picture Popup
function closeProfilePicturePopup() {
  document.getElementById("profile-picture-popup").classList.add("hidden");
}

// Simulated functions for photo selection
function takePhoto() {
  alert("Taking a new photo...");
  closeProfilePicturePopup();
}

function selectPhoto() {
  // Deprecated; replaced by savePopupProfileImage via file picker
  document.getElementById('popup-profile-upload')?.click();
}

function openProfilePicturePopup() {
  document.getElementById('profile-picture-popup').classList.remove('hidden');
}
function closeProfilePicturePopup() {
  document.getElementById('profile-picture-popup').classList.add('hidden');
}
async function savePopupProfileImage() {
  const input = document.getElementById('popup-profile-upload');
  const file = input && input.files && input.files[0];
  if (!file) { closeProfilePicturePopup(); return; }
  const formData = new FormData();
  formData.append('userId', studentId);
  formData.append('profileImage', file);
  try {
    const res = await fetch(`${API_BASE}/update-account`, { method: 'POST', body: formData });
    if (!res.ok) throw new Error('Failed to upload profile image');
    await fetchProfile();
    closeProfilePicturePopup();
  } catch (e) {
    console.error('Profile image upload error:', e);
    alert('Failed to upload profile image');
  }
}

// Save New Password
function saveNewPassword() {
  const currentPassword = document.getElementById("current-password").value;
  const newPassword = document.getElementById("new-password").value;
  const confirmPassword = document.getElementById("confirm-password").value;

  if (!currentPassword || !newPassword || !confirmPassword) {
    alert("Please fill out all password fields.");
    return;
  }

  if (newPassword !== confirmPassword) {
    alert("New password and confirmation do not match.");
    return;
  }

  alert("Password changed successfully!");
  closePasswordPopup();
}

// Forgot Password Function
function forgotPassword() {
}

// Logout Functions
function confirmLogout() {
    if (confirm("Are you sure you want to logout?")) {
        logout();
    }
}

function logout() {
    // Clear all user data from localStorage
    localStorage.removeItem('userId');
    localStorage.removeItem('userName');
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userRole');
    
    // Redirect to home page
    window.location.href = 'index.html';
}

// Toggle dropdown menu
function toggleDropdown() {
    const dropdown = document.getElementById('dropdown-menu');
    dropdown.classList.toggle('hidden');
}

// Update dashboard overview with real data
async function updateDashboardOverview() {
    try {
        const response = await fetch(`${API_BASE}/orders/${studentId}`);
        const result = await response.json();
        
        if (response.ok && result.orders) {
            const orders = result.orders;
            
            // Calculate comprehensive stats
            const activeOrders = orders.filter(order => ['assigned', 'in-progress'].includes(order.status)).length;
            const upcomingDeadlines = orders.filter(order => {
                const deadline = new Date(order.deadline);
                const now = new Date();
                const threeDaysFromNow = new Date(now.getTime() + (3 * 24 * 60 * 60 * 1000));
                return deadline <= threeDaysFromNow && deadline > now && !['completed', 'cancelled'].includes(order.status);
            }).length;
            
            const checkingBalanceOrders = orders.filter(order => order.status === 'checking-balance');
            const totalPendingPayments = checkingBalanceOrders.reduce((sum, order) => sum + order.totalCost, 0);
            
            const completedOrders = orders.filter(order => order.status === 'completed' && order.completedFiles && order.completedFiles.length > 0);
            const newFeedback = completedOrders.filter(order => order.tutorComments && order.tutorComments.trim() !== '').length;
            
            // Update dashboard cards
            const activeCard = document.querySelector('.text-blue-600.text-xl.font-bold');
            if (activeCard) activeCard.textContent = `${activeOrders} in progress`;
            
            const deadlineCard = document.querySelector('.text-green-600.text-xl.font-bold');
            if (deadlineCard) deadlineCard.textContent = `${upcomingDeadlines} approaching`;
            
            const paymentCard = document.querySelector('.text-purple-600.text-xl.font-bold');
            if (paymentCard) paymentCard.textContent = `$${totalPendingPayments.toFixed(2)} due`;
            
            const feedbackCard = document.querySelector('.text-pink-600.text-xl.font-bold');
            if (feedbackCard) feedbackCard.textContent = `${newFeedback} new comment${newFeedback !== 1 ? 's' : ''}`;

            // Messages and profile updates (placeholder for now)
            const messageCard = document.querySelector('.text-yellow-600.text-xl.font-bold');
            if (messageCard) messageCard.textContent = `0 unread`;
            
            const profileCard = document.querySelector('.text-teal-600.text-xl.font-bold');
            if (profileCard) profileCard.textContent = `0 new updates`;
        }
    } catch (error) {
        console.error('Error updating dashboard overview:', error);
    }
}

// Load user payments
async function loadUserPayments() {
    try {
        const response = await fetch(`${API_BASE}/payments/${studentId}`);
        const result = await response.json();
        
        if (result.success) {
            displayPaymentHistory(result.payments);
        }
    } catch (error) {
        console.error('Error loading payments:', error);
    }
}

// Display payment history
function displayPaymentHistory(payments) {
    const container = document.getElementById('paymentsList');
    if (!container) { console.log('Payment history:', payments); return; }
    container.innerHTML = '';
    payments.forEach(p => {
        const el = document.createElement('div');
        el.className = 'flex justify-between items-center py-2 border-b border-gray-100';
        const amountText = (p.amount >= 0 ? `+$${p.amount.toFixed(2)}` : `-$${Math.abs(p.amount).toFixed(2)}`);
        el.innerHTML = `
          <div class="text-sm text-gray-700">${new Date(p.createdAt).toLocaleString()}</div>
          <div class="text-sm font-medium">${p.method}</div>
          <div class="text-sm ${p.amount>=0? 'text-green-600':'text-red-600'}">${amountText}</div>
          <div class="text-xs text-gray-500">${p.status}</div>
        `;
        container.appendChild(el);
    });
}

// Check if balance notification should be shown
async function checkBalanceNotification() {
    try {
        const response = await fetch(`${API_BASE}/orders/${studentId}`);
        const result = await response.json();
        
        if (response.ok && result.orders) {
            const checkingBalanceOrders = result.orders.filter(order => order.status === 'checking-balance');
            const totalPendingCost = checkingBalanceOrders.reduce((sum, order) => sum + order.totalCost, 0);
            
            // Get current user balance
            const userResponse = await fetch(`${API_BASE}/user/${studentId}`);
            const userResult = await userResponse.json();
            
            if (userResponse.ok && userResult.user) {
                const currentBalance = userResult.user.walletBalance || 0;
                
                if (totalPendingCost > currentBalance && totalPendingCost > 0) {
                    document.getElementById('balanceNotification').classList.remove('hidden');
                } else {
                    document.getElementById('balanceNotification').classList.add('hidden');
                }
            }
        }
    } catch (error) {
        console.error('Error checking balance notification:', error);
    }
}

// Initialize the page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  fetchProfile(); // Load user profile
  fetchHomework(); // Load assignments
  updateDashboardOverview(); // Update dashboard cards
  // Messages are loaded via SSE when assignment is selected
  loadUserPayments(); // Load payment history
  checkBalanceNotification(); // Check if balance notification should be shown
  
  // Theme controls
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.classList.toggle('dark', savedTheme === 'dark');
  document.querySelectorAll('input[name="theme"]').forEach(r => {
    r.checked = (r.value === savedTheme);
    r.addEventListener('change', () => {
      const mode = r.value;
      localStorage.setItem('theme', mode);
      document.documentElement.classList.toggle('dark', mode === 'dark');
    });
  });
  
  // Set up periodic refresh for real-time updates
  setInterval(() => {
    fetchHomework(); // Refresh assignments
    updateDashboardOverview(); // Refresh dashboard
    checkBalanceNotification(); // Check balance status
  }, 30000); // Refresh every 30 seconds
});

// Also call fetchHomework when assignments section is shown
function showSection(sectionId) {
  // Hide all sections
  const sections = document.querySelectorAll('main > section');
  sections.forEach(section => section.classList.add('hidden'));
  
  // Show selected section
  document.getElementById(sectionId).classList.remove('hidden');
  
  // Update section titles
  const sectionTitles = {
    'overview': 'Dashboard',
    'assignments': 'Assignments',
    'messages': 'Messages',
    'payments': 'Payments',
    'profile': 'Profile'
  };
  
  const title = sectionTitles[sectionId] || 'Dashboard';
  document.getElementById('section-title-mobile').textContent = title;
  document.getElementById('section-title-large').textContent = title;
  
  // Load data when specific sections are shown
  if (sectionId === 'assignments') {
    fetchHomework();
  } else if (sectionId === 'messages') {
    // Messages are loaded via SSE when assignment is selected
  } else if (sectionId === 'payments') {
    loadUserPayments();
    checkBalanceNotification();
  } else if (sectionId === 'overview') {
    updateDashboardOverview();
  }
}

// Order Modal Functions
let isPlacingOrder = false;
function openOrderModal() {
    document.getElementById('orderModal').classList.remove('hidden');
    // Set minimum date to current date + 2 hours
    const now = new Date();
    now.setHours(now.getHours() + 2);
    document.getElementById('dueDateTime').min = now.toISOString().slice(0, 16);
}

function closeOrderModal() {
    document.getElementById('orderModal').classList.add('hidden');
    document.getElementById('orderForm').reset();
    resetPriceCalculator();
}

// Subject selection handler
function getSelectedSubject() {
    const subjects = [
        'liberalArtsSubject', 'businessSubject', 'scienceSubject', 
        'technicalSubject', 'customSubject'
    ];
    
    for (let subjectId of subjects) {
        const element = document.getElementById(subjectId);
        if (element.value) {
            return element.value;
        }
    }
    return '';
}

// Assignment type change handler
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for assignment type selection
    const assignmentTypes = document.querySelectorAll('input[name="assignmentType"]');
    assignmentTypes.forEach(radio => {
        radio.addEventListener('change', function() {
            updatePriceCalculator();
            toggleSections();
        });
    });
    
    // Add event listener for pages input
    document.getElementById('pages').addEventListener('input', updatePriceCalculator);
    
    // Add event listener for due date validation
    document.getElementById('dueDateTime').addEventListener('change', validateDueDate);
    
    // Add event listener for file upload
    document.getElementById('fileUpload').addEventListener('change', handleFileUpload);
});

function toggleSections() {
    const selectedType = document.querySelector('input[name="assignmentType"]:checked');
    const pagesSection = document.getElementById('pagesSection');
    const technicalNote = document.getElementById('technicalNote');
    
    if (selectedType) {
        const category = selectedType.dataset.category;
        
        if (category === 'technical') {
            pagesSection.classList.add('hidden');
            technicalNote.classList.remove('hidden');
        } else {
            pagesSection.classList.remove('hidden');
            technicalNote.classList.add('hidden');
        }
    }
}

function updatePriceCalculator() {
    const selectedType = document.querySelector('input[name="assignmentType"]:checked');
    const pages = parseInt(document.getElementById('pages').value) || 0;
    
    if (!selectedType) {
        resetPriceCalculator();
        return;
    }
    
    const price = selectedType.dataset.price;
    const category = selectedType.dataset.category;
    const typeName = selectedType.nextElementSibling.textContent;
    
    document.getElementById('selectedType').textContent = typeName;
    
    if (price === 'custom') {
        document.getElementById('selectedPages').textContent = 'N/A';
        document.getElementById('pricePerPage').textContent = 'Custom Quote';
        document.getElementById('totalCost').textContent = 'TBD';
        document.getElementById('customPriceNote').classList.remove('hidden');
    } else {
        document.getElementById('selectedPages').textContent = pages || '-';
        document.getElementById('pricePerPage').textContent = `$${price}`;
        
        const totalCost = pages * parseFloat(price);
        document.getElementById('totalCost').textContent = `$${totalCost.toFixed(2)}`;
        document.getElementById('customPriceNote').classList.add('hidden');
    }
}

function resetPriceCalculator() {
    document.getElementById('selectedType').textContent = '-';
    document.getElementById('selectedPages').textContent = '-';
    document.getElementById('pricePerPage').textContent = '-';
    document.getElementById('totalCost').textContent = '$0.00';
    document.getElementById('customPriceNote').classList.add('hidden');
}

function validateDueDate() {
    const dueDateTime = new Date(document.getElementById('dueDateTime').value);
    const now = new Date();
    const twoHoursFromNow = new Date(now.getTime() + (2 * 60 * 60 * 1000));
    const timeWarning = document.getElementById('timeWarning');
    
    if (dueDateTime <= twoHoursFromNow) {
        timeWarning.classList.remove('hidden');
        return false;
    } else {
        timeWarning.classList.add('hidden');
        return true;
    }
}

function handleFileUpload() {
    const fileInput = document.getElementById('fileUpload');
    const fileList = document.getElementById('fileList');
    const files = Array.from(fileInput.files);
    
    if (files.length === 0) {
        fileList.innerHTML = '';
        return;
    }
    
    fileList.innerHTML = '<h5 class="font-medium text-gray-700 mb-2">Selected Files:</h5>';
    
    files.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'flex items-center justify-between bg-gray-100 p-2 rounded mb-2';
        fileItem.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-file text-blue-500 mr-2"></i>
                <span class="text-sm">${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
            </div>
            <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700">
                <i class="fas fa-times"></i>
            </button>
        `;
        fileList.appendChild(fileItem);
    });
}

function removeFile(index) {
    const fileInput = document.getElementById('fileUpload');
    const dt = new DataTransfer();
    const files = Array.from(fileInput.files);
    
    files.forEach((file, i) => {
        if (i !== index) {
            dt.items.add(file);
        }
    });
    
    fileInput.files = dt.files;
    handleFileUpload();
}

// Order form submission
document.addEventListener('DOMContentLoaded', function() {
    let isPlacingOrder = false;
    const formEl = document.getElementById('orderForm');
    formEl.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (isPlacingOrder) return;
        
        // Validate form
        if (!validateOrderForm()) {
            return;
        }
        
        isPlacingOrder = true;
        const btn = document.getElementById('submitOrderBtn');
        const btnText = btn?.querySelector('.btn-text');
        const originalHTML = btn?.innerHTML;
        if (btn) {
          btn.disabled = true;
          btn.classList.add('opacity-60','cursor-not-allowed');
          if (btnText) btnText.textContent = 'Submitting...';
        }
        
        // Get form data
        const formData = getOrderFormData();
        
        try {
            // Create FormData for file upload
            const submitData = new FormData();
            
            // Add all form fields
            Object.keys(formData).forEach(key => {
                submitData.append(key, formData[key]);
            });
            
            // Add files if any
            const fileInput = document.getElementById('fileUpload');
            if (fileInput && fileInput.files) {
                for (let i = 0; i < fileInput.files.length; i++) {
                    submitData.append('files', fileInput.files[i]);
                }
            }
            
            const response = await fetch(`${API_BASE}/place-order`, {
                method: 'POST',
                body: submitData // Don't set Content-Type header for FormData
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showSuccessMessage(result.order);
                closeOrderModal();
                fetchHomework();
                updateDashboardOverview();
            } else {
                alert(result.message || 'Failed to place order. Please try again.');
            }
        } catch (error) {
            console.error('Order placement error:', error);
            alert('An error occurred. Please try again.');
        } finally {
            isPlacingOrder = false;
            if (btn) {
              btn.disabled = false;
              btn.classList.remove('opacity-60','cursor-not-allowed');
              if (btnText) btnText.textContent = 'Submit Order';
              else btn.innerHTML = originalHTML;
            }
        }
    }, { once: false });
});

function validateOrderForm() {
    // Check if subject is selected
    const subject = getSelectedSubject();
    if (!subject) {
        alert('Please select a subject.');
        return false;
    }
    
    // Check if assignment type is selected
    const selectedType = document.querySelector('input[name="assignmentType"]:checked');
    if (!selectedType) {
        alert('Please select an assignment type.');
        return false;
    }
    
    // Check pages for non-technical assignments
    if (selectedType.dataset.category !== 'technical') {
        const pages = parseInt(document.getElementById('pages').value);
        if (!pages || pages < 1) {
            alert('Please enter the number of pages.');
            return false;
        }
    }
    
    // Check assignment title
    if (!document.getElementById('assignmentTitle').value.trim()) {
        alert('Please enter an assignment title.');
        return false;
    }
    
    // Check assignment description
    if (!document.getElementById('assignmentDescription').value.trim()) {
        alert('Please provide assignment instructions.');
        return false;
    }
    
    // Check due date
    if (!document.getElementById('dueDateTime').value) {
        alert('Please select a due date and time.');
        return false;
    }
    
    // Validate due date is not within 2 hours
    if (!validateDueDate()) {
        alert('Assignments due within 2 hours cannot be accepted. Please select a later due date.');
        return false;
    }
    
    return true;
}

function getOrderFormData() {
    const selectedType = document.querySelector('input[name="assignmentType"]:checked');
    const subject = getSelectedSubject();
    const pages = parseInt(document.getElementById('pages').value) || 0;
    const price = selectedType.dataset.price;
    
    let totalCost = 0;
    if (price !== 'custom') {
        totalCost = pages * parseFloat(price);
    }
    
    return {
        userId: studentId,
        subject: subject,
        orderType: selectedType.value,
        assignmentTitle: document.getElementById('assignmentTitle').value.trim(),
        description: document.getElementById('assignmentDescription').value.trim(),
        additionalRequirements: document.getElementById('additionalRequirements').value.trim(),
        pages: pages,
        deadline: document.getElementById('dueDateTime').value,
        category: selectedType.dataset.category,
        pricePerPage: price === 'custom' ? 0 : parseFloat(price),
        totalCost: totalCost,
        status: selectedType.dataset.category === 'technical' ? 'under-review' : 'pending',
        hasFiles: document.getElementById('fileUpload').files.length > 0
    };
}

// Show success message after order placement
function showSuccessMessage(order) {
    // Create success modal
    const successModal = document.createElement('div');
    successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    successModal.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center animate-slide-down">
            <div class="mb-4">
                <i class="fas fa-check-circle text-green-500 text-6xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Order Placed Successfully! 🎉</h3>
            <p class="text-gray-600 mb-4">Your assignment has been submitted for review.</p>
            
            <div class="bg-gray-50 rounded-lg p-4 mb-4 text-left">
                <h4 class="font-semibold text-gray-800 mb-2">Order Details:</h4>
                <p class="text-sm text-gray-600"><strong>Order ID:</strong> ${order.id}</p>
                <p class="text-sm text-gray-600"><strong>Assignment:</strong> ${order.assignmentTitle}</p>
                <p class="text-sm text-gray-600"><strong>Subject:</strong> ${order.subject}</p>
                <p class="text-sm text-gray-600"><strong>Due:</strong> ${new Date(order.deadline).toLocaleDateString()}</p>
                ${order.totalCost > 0 ? `<p class="text-sm text-gray-600"><strong>Cost:</strong> $${order.totalCost.toFixed(2)}</p>` : ''}
            </div>
            
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-2">
                <div class="flex items-center space-x-2 text-green-800">
                    <i class="fas fa-shield-alt"></i>
                    <span class="font-semibold">Payment Protection Active</span>
                </div>
                <p class="text-green-700 text-sm mt-1">
                    You won't be charged until we review and approve your order.
                </p>
            </div>
            <p id="success-timer" class="text-xs text-gray-500">Closing in 5s...</p>
        </div>
    `;
    
    document.body.appendChild(successModal);
    
    // Auto-close after 5 seconds with countdown
    let remaining = 5;
    const label = successModal.querySelector('#success-timer');
    const interval = setInterval(() => {
        remaining -= 1;
        if (label) label.textContent = `Closing in ${remaining}s...`;
        if (remaining <= 0) {
            clearInterval(interval);
            closeSuccessMessage();
        }
    }, 1000);
}

function closeSuccessMessage() {
    const successModal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
    if (successModal) {
        successModal.remove();
    }
}

// Payment System Functions
let selectedPaymentAmount = 0;

// Set amount for payment
function setAmount(amount) {
    document.getElementById('depositAmount').value = amount;
    selectedPaymentAmount = amount;
}

// Select payment method
function selectPaymentMethod(method) {
    const amount = parseFloat(document.getElementById('depositAmount').value);
    
    if (!amount || amount < 10) {
        alert('Please enter an amount of at least $10');
        return;
    }
    
    selectedPaymentAmount = amount;
    
    // Update amount displays in modals
    const updates = [
        'paystackAmount','paypalAmount','cashappAmount','cashappAmountText','bitcoinAmount','bitcoinAmountText'
    ];
    updates.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = `$${amount.toFixed(2)}`;
    });
    
    // Show appropriate modal
    switch(method) {
        case 'paystack':
            document.getElementById('paystackModal').classList.remove('hidden');
            break;
        case 'paypal':
            document.getElementById('paypalModal').classList.remove('hidden');
            break;
        case 'cashapp':
            document.getElementById('cashappModal').classList.remove('hidden');
            break;
        case 'bitcoin':
            document.getElementById('bitcoinModal').classList.remove('hidden');
            break;
    }
}

// Close payment modal
function closePaymentModal() {
    document.getElementById('paystackModal').classList.add('hidden');
    document.getElementById('paypalModal').classList.add('hidden');
    document.getElementById('cashappModal').classList.add('hidden');
    document.getElementById('bitcoinModal').classList.add('hidden');
}

// Process Paystack payment
function processPaystackPayment() {
    // Initialize Paystack payment
    const handler = PaystackPop.setup({
        key: 'pk_test_232531a5c927ef2cc67ed1b85af3f26e3b8ed2f2',
        email: (localStorage.getItem('userEmail') || document.getElementById('user-email')?.textContent?.trim() || ''),
        amount: selectedPaymentAmount * 100, // Amount in kobo
        currency: 'USD',
        callback: function(response) {
            // Payment successful
            updateUserBalance(selectedPaymentAmount, 'paystack', response.reference);
            closePaymentModal();
            showPaymentSuccess('Paystack', selectedPaymentAmount, response.reference);
        },
        onClose: function() {
            alert('Payment cancelled');
        }
    });
    handler.openIframe();
}

// Process PayPal payment
function processPaypalPayment() {
    // Simulate PayPal payment (in real implementation, use PayPal SDK)
    setTimeout(() => {
        const reference = 'PP' + Date.now();
        updateUserBalance(selectedPaymentAmount, 'paypal', reference);
        closePaymentModal();
        showPaymentSuccess('PayPal', selectedPaymentAmount, reference);
    }, 2000);
}

// Submit CashApp payment
function submitCashappPayment() {
    const proofFile = document.getElementById('cashappProof').files[0];
    
    if (!proofFile) {
        alert('Please upload payment proof');
        return;
    }
    
    // Create FormData for file upload
    const formData = new FormData();
    formData.append('amount', selectedPaymentAmount);
    formData.append('method', 'cashapp');
    formData.append('proof', proofFile);
    formData.append('userId', studentId);
    
    // Submit to server for manual approval
    fetch(`${API_BASE}/submit-payment-proof`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closePaymentModal();
            showPaymentPending('CashApp', selectedPaymentAmount);
        } else {
            alert('Failed to submit payment proof: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error submitting payment proof:', error);
        alert('Error submitting payment proof. Please try again.');
    });
}

// Submit Bitcoin payment
function submitBitcoinPayment() {
    const proofFile = document.getElementById('bitcoinProof').files[0];
    
    if (!proofFile) {
        alert('Please upload payment proof');
        return;
    }
    
    // Create FormData for file upload
    const formData = new FormData();
    formData.append('amount', selectedPaymentAmount);
    formData.append('method', 'bitcoin');
    formData.append('proof', proofFile);
    formData.append('userId', studentId);
    
    // Submit to server for manual approval
    fetch(`${API_BASE}/submit-payment-proof`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closePaymentModal();
            showPaymentPending('Bitcoin', selectedPaymentAmount);
        } else {
            alert('Failed to submit payment proof: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error submitting payment proof:', error);
        alert('Error submitting payment proof. Please try again.');
    });
}

// Copy Bitcoin address
function copyBitcoinAddress() {
    const address = '1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa';
    navigator.clipboard.writeText(address).then(() => {
        alert('Bitcoin address copied to clipboard!');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = address;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Bitcoin address copied to clipboard!');
    });
}

function openWithdrawPrompt() {
  const amtStr = prompt('Enter amount to withdraw:');
  if (!amtStr) return;
  const amt = Number(amtStr);
  if (!amt || amt <= 0) return alert('Enter a valid amount');
  const method = prompt('Enter method (paypal/bitcoin/cashapp):', 'paypal') || 'paypal';
  const destination = prompt('Destination (email/wallet/account):', '') || '';
  requestWithdraw(amt, method, destination);
}

async function requestWithdraw(amount, method, destination) {
  try {
    const res = await fetch(`${API_BASE}/payments/request-withdraw`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: studentId, amount, method, destination })
    });
    const result = await res.json();
    if (result.success) {
      alert('Withdraw requested. You will be notified after approval.');
    } else {
      alert(result.message || 'Failed to request withdraw');
    }
  } catch (e) {
    console.error('Withdraw request error:', e);
    alert('Error requesting withdraw');
  }
}

// Update user balance
async function updateUserBalance(amount, method = 'paystack', reference = '') {
    try {
        const response = await fetch(`${API_BASE}/update-balance`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: studentId,
                amount: amount,
                method: method,
                reference: reference
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update balance display
            document.getElementById('userBalance').textContent = `$${result.newBalance.toFixed(2)}`;
            // Hide balance notification if it was showing
            document.getElementById('balanceNotification').classList.add('hidden');
            // Refresh assignments to update status
            fetchHomework();
            updateDashboardOverview();
        }
    } catch (error) {
        console.error('Error updating balance:', error);
    }
}


// Show payment success message
function showPaymentSuccess(method, amount, reference) {
    const successModal = document.createElement('div');
    successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    successModal.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
            <div class="mb-4">
                <i class="fas fa-check-circle text-green-500 text-6xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Payment Successful! 🎉</h3>
            <p class="text-gray-600 mb-4">Your account has been credited.</p>
            
            <div class="bg-gray-50 rounded-lg p-4 mb-4 text-left">
                <h4 class="font-semibold text-gray-800 mb-2">Payment Details:</h4>
                <p class="text-sm text-gray-600"><strong>Method:</strong> ${method}</p>
                <p class="text-sm text-gray-600"><strong>Amount:</strong> $${amount.toFixed(2)}</p>
                <p class="text-sm text-gray-600"><strong>Reference:</strong> ${reference}</p>
            </div>
            
            <button onclick="closePaymentSuccess()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
                <i class="fas fa-thumbs-up mr-2"></i>Great!
            </button>
        </div>
    `;
    
    document.body.appendChild(successModal);
    
    // Auto-close after 5 seconds
    setTimeout(() => {
        if (document.body.contains(successModal)) {
            closePaymentSuccess();
        }
    }, 5000);
}

// Show payment pending message
function showPaymentPending(method, amount) {
    const pendingModal = document.createElement('div');
    pendingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    pendingModal.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
            <div class="mb-4">
                <i class="fas fa-clock text-yellow-500 text-6xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Payment Submitted! ⏳</h3>
            <p class="text-gray-600 mb-4">Your payment proof has been submitted for review.</p>
            
            <div class="bg-yellow-50 rounded-lg p-4 mb-4 text-left">
                <h4 class="font-semibold text-gray-800 mb-2">Submission Details:</h4>
                <p class="text-sm text-gray-600"><strong>Method:</strong> ${method}</p>
                <p class="text-sm text-gray-600"><strong>Amount:</strong> $${amount.toFixed(2)}</p>
                <p class="text-sm text-gray-600"><strong>Status:</strong> Pending Approval</p>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                <p class="text-blue-800 text-sm">
                    <i class="fas fa-info-circle mr-2"></i>
                    Your account will be credited once the payment is approved by our team.
                </p>
            </div>
            
            <button onclick="closePaymentSuccess()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                <i class="fas fa-check mr-2"></i>Got It!
            </button>
        </div>
    `;
    
    document.body.appendChild(pendingModal);
}

// Close payment success/pending modal
function closePaymentSuccess() {
    const modals = document.querySelectorAll('.fixed.inset-0.bg-black.bg-opacity-50');
    modals.forEach(m => m.remove());
}

// Check if user needs to top up balance (server-driven)
async function checkBalanceNotification() {
    try {
        const response = await fetch(`${API_BASE}/check-balance/${studentId}`);
        const result = await response.json();
        if (response.ok && result.success) {
            const notif = document.getElementById('balanceNotification');
            if (result.needsTopUp && result.checkingBalanceOrders > 0) {
                notif.classList.remove('hidden');
            } else {
                notif.classList.add('hidden');
            }
            // Keep top-of-section balance in sync too
            const userBalanceElement = document.getElementById('userBalance');
            if (userBalanceElement && typeof result.balance === 'number') {
                userBalanceElement.textContent = `$${Number(result.balance).toFixed(2)}`;
            }
        }
    } catch (e) {
        console.error('Error checking balance:', e);
    }
}

// Load Paystack script
function loadPaystackScript() {
    if (!document.getElementById('paystack-script')) {
        const script = document.createElement('script');
        script.id = 'paystack-script';
        script.src = 'https://js.paystack.co/v1/inline.js';
        document.head.appendChild(script);
    }
}

// Initialize payment system
document.addEventListener('DOMContentLoaded', function() {
    loadPaystackScript();
    // Load PayPal SDK
    if (!document.getElementById('paypal-sdk')) {
      const s = document.createElement('script');
      s.id = 'paypal-sdk';
      s.src = 'https://www.paypal.com/sdk/js?client-id=sb&currency=USD'; // sb = sandbox client id
      s.onload = () => {
        if (window.paypal) {
          try {
            paypal.Buttons({
              createOrder: function(data, actions) {
                return actions.order.create({
                  purchase_units: [{ amount: { value: (selectedPaymentAmount || 0).toFixed(2) } }]
                });
              },
              onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                  const reference = details.id;
                  updateUserBalance(selectedPaymentAmount, 'paypal', reference);
                  closePaymentModal();
                  showPaymentSuccess('PayPal', selectedPaymentAmount, reference);
                });
              }
            }).render('#paypal-buttons');
          } catch(e) { console.error('PayPal init error:', e); }
        }
      };
      document.head.appendChild(s);
    }
    checkBalanceNotification();
});

    </script>

<!-- Payment Modals -->

<!-- Paystack Modal -->
<div id="paystackModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg max-w-md w-full mx-4">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800">Pay with Paystack</h3>
        <button onclick="closePaymentModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-credit-card text-2xl text-blue-600"></i>
        </div>
        <p class="text-gray-600">Amount: <span class="font-semibold text-xl" id="paystackAmount">$0.00</span></p>
      </div>
      
      <button onclick="processPaystackPayment()" 
              class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700">
        <i class="fas fa-credit-card mr-2"></i>Pay Now
      </button>
    </div>
  </div>
</div>

<!-- PayPal Modal -->
<div id="paypalModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg max-w-md w-full mx-4">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800">Pay with PayPal</h3>
        <button onclick="closePaymentModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fab fa-paypal text-2xl text-blue-600"></i>
        </div>
        <p class="text-gray-600">Amount: <span class="font-semibold text-xl" id="paypalAmount">$0.00</span></p>
      </div>
      
      <div id="paypal-buttons"></div>
    </div>
  </div>
</div>

<!-- CashApp Bitcoin Modal -->
<div id="cashappModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800">CashApp Bitcoin Payment</h3>
        <button onclick="closePaymentModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <div class="flex items-center space-x-2 text-green-800 mb-2">
          <i class="fas fa-info-circle"></i>
          <span class="font-semibold">CashApp Bitcoin Payment Instructions</span>
        </div>
        <div class="text-green-700 text-sm space-y-2">
          <p><strong>Amount to Pay:</strong> <span id="cashappAmount" class="font-semibold">$0.00</span></p>
          <p><strong>Payment Method:</strong> Bitcoin only via CashApp</p>
        </div>
      </div>

      <div class="space-y-4">
        <div class="bg-gray-50 rounded-lg p-4">
          <h4 class="font-semibold text-gray-800 mb-3">How to Pay with CashApp Bitcoin:</h4>
          <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700">
            <li>Open your CashApp mobile application</li>
            <li>Tap on the "Bitcoin" tab at the bottom</li>
            <li>Select "Send Bitcoin" or "Withdraw Bitcoin"</li>
            <li>Enter the Bitcoin address below</li>
            <li>Enter the equivalent Bitcoin amount for <span id="cashappAmountText">$0.00</span></li>
            <li>Complete the transaction</li>
            <li>Take a screenshot of the transaction confirmation</li>
            <li>Upload the screenshot below as proof of payment</li>
          </ol>
        </div>

        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <h4 class="font-semibold text-gray-800 mb-2">Bitcoin Address:</h4>
          <div class="flex items-center space-x-2">
            <code class="bg-gray-100 px-3 py-2 rounded text-sm flex-1 break-all">1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa</code>
            <button onclick="copyBitcoinAddress()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Upload Payment Proof *</label>
          <input type="file" id="cashappProof" accept="image/*" 
                 class="w-full border border-gray-300 rounded-md p-2">
          <p class="text-xs text-gray-500 mt-1">Upload screenshot of your CashApp Bitcoin transaction</p>
        </div>

        <div class="flex space-x-3">
          <button onclick="closePaymentModal()" 
                  class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400">
            Cancel
          </button>
          <button onclick="submitCashappPayment()" 
                  class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
            <i class="fas fa-upload mr-2"></i>Submit Payment
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bitcoin Modal -->
<div id="bitcoinModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800">Bitcoin Payment</h3>
        <button onclick="closePaymentModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
        <div class="flex items-center space-x-2 text-yellow-800 mb-2">
          <i class="fab fa-bitcoin"></i>
          <span class="font-semibold">Bitcoin Direct Payment</span>
        </div>
        <div class="text-yellow-700 text-sm space-y-2">
          <p><strong>Amount to Pay:</strong> <span id="bitcoinAmount" class="font-semibold">$0.00</span></p>
          <p><strong>Payment Method:</strong> Direct Bitcoin transfer</p>
        </div>
      </div>

      <div class="space-y-4">
        <div class="bg-gray-50 rounded-lg p-4">
          <h4 class="font-semibold text-gray-800 mb-3">Bitcoin Payment Instructions:</h4>
          <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700">
            <li>Copy the Bitcoin address below</li>
            <li>Open your Bitcoin wallet application</li>
            <li>Send the equivalent Bitcoin amount for <span id="bitcoinAmountText">$0.00</span></li>
            <li>Use the Bitcoin address provided</li>
            <li>Complete the transaction</li>
            <li>Take a screenshot of the transaction confirmation</li>
            <li>Upload the screenshot below as proof of payment</li>
          </ol>
        </div>

        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <h4 class="font-semibold text-gray-800 mb-2">Bitcoin Address:</h4>
          <div class="flex items-center space-x-2">
            <code class="bg-gray-100 px-3 py-2 rounded text-sm flex-1 break-all">1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa</code>
            <button onclick="copyBitcoinAddress()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Upload Payment Proof *</label>
          <input type="file" id="bitcoinProof" accept="image/*" 
                 class="w-full border border-gray-300 rounded-md p-2">
          <p class="text-xs text-gray-500 mt-1">Upload screenshot of your Bitcoin transaction</p>
        </div>

        <div class="flex space-x-3">
          <button onclick="closePaymentModal()" 
                  class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400">
            Cancel
          </button>
          <button onclick="submitBitcoinPayment()" 
                  class="flex-1 bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700">
            <i class="fas fa-upload mr-2"></i>Submit Payment
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chat Settings Modal -->
<div id="chatSettingsModal" class="fixed inset-0 settings-modal hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-xl max-w-4xl w-full mx-4 settings-content">
    <div class="p-6">
      <!-- Header -->
      <div class="flex justify-between items-center mb-6">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
            <i class="fas fa-palette text-white"></i>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-gray-800">Chat Themes</h2>
            <p class="text-gray-600">Customize your chat experience</p>
          </div>
        </div>
        <button onclick="closeChatSettings()" class="text-gray-500 hover:text-gray-700 text-2xl">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Theme Selection -->
      <div class="mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Choose Your Theme</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          
          <!-- Default Theme -->
          <div class="theme-preview bg-white border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 transition-all" data-theme="default" onclick="showThemePreview('default')">
            <div class="mb-3">
              <h4 class="font-semibold text-gray-800">Classic Blue</h4>
              <p class="text-sm text-gray-600">Clean and professional</p>
            </div>
            <div class="space-y-2">
              <div class="bg-blue-500 text-white p-2 rounded-lg text-sm ml-auto max-w-[80%]">
                Your message
              </div>
              <div class="bg-gray-100 text-gray-800 p-2 rounded-lg text-sm mr-auto max-w-[80%]">
                Tutor response
              </div>
            </div>
          </div>

          <!-- Ocean Theme -->
          <div class="theme-preview bg-white border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 transition-all" data-theme="ocean" onclick="showThemePreview('ocean')">
            <div class="mb-3">
              <h4 class="font-semibold text-gray-800">Ocean Waves</h4>
              <p class="text-sm text-gray-600">Deep blue gradients</p>
            </div>
            <div class="space-y-2">
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" class="text-white p-2 rounded-lg text-sm ml-auto max-w-[80%]">
                Your message
              </div>
              <div class="bg-blue-50 text-blue-800 p-2 rounded-lg text-sm mr-auto max-w-[80%]">
                Tutor response
              </div>
            </div>
          </div>

          <!-- Sunset Theme -->
          <div class="theme-preview bg-white border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 transition-all" data-theme="sunset" onclick="showThemePreview('sunset')">
            <div class="mb-3">
              <h4 class="font-semibold text-gray-800">Sunset Glow</h4>
              <p class="text-sm text-gray-600">Warm pink tones</p>
            </div>
            <div class="space-y-2">
              <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);" class="text-gray-700 p-2 rounded-lg text-sm ml-auto max-w-[80%]">
                Your message
              </div>
              <div class="bg-orange-50 text-orange-800 p-2 rounded-lg text-sm mr-auto max-w-[80%]">
                Tutor response
              </div>
            </div>
          </div>

          <!-- Forest Theme -->
          <div class="theme-preview bg-white border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 transition-all" data-theme="forest" onclick="showThemePreview('forest')">
            <div class="mb-3">
              <h4 class="font-semibold text-gray-800">Forest Green</h4>
              <p class="text-sm text-gray-600">Natural and fresh</p>
            </div>
            <div class="space-y-2">
              <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);" class="text-white p-2 rounded-lg text-sm ml-auto max-w-[80%]">
                Your message
              </div>
              <div class="bg-green-50 text-green-800 p-2 rounded-lg text-sm mr-auto max-w-[80%]">
                Tutor response
              </div>
            </div>
          </div>

          <!-- Midnight Theme -->
          <div class="theme-preview bg-white border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 transition-all" data-theme="midnight" onclick="showThemePreview('midnight')">
            <div class="mb-3">
              <h4 class="font-semibold text-gray-800">Midnight Dark</h4>
              <p class="text-sm text-gray-600">Sleek and modern</p>
            </div>
            <div class="space-y-2">
              <div style="background: linear-gradient(135deg, #2c3e50 0%, #4a6741 100%);" class="text-white p-2 rounded-lg text-sm ml-auto max-w-[80%]">
                Your message
              </div>
              <div class="bg-gray-700 text-gray-100 p-2 rounded-lg text-sm mr-auto max-w-[80%]">
                Tutor response
              </div>
            </div>
          </div>

          <!-- Candy Theme -->
          <div class="theme-preview bg-white border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 transition-all" data-theme="candy" onclick="showThemePreview('candy')">
            <div class="mb-3">
              <h4 class="font-semibold text-gray-800">Sweet Candy</h4>
              <p class="text-sm text-gray-600">Playful and bright</p>
            </div>
            <div class="space-y-2">
              <div style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);" class="text-white p-2 rounded-lg text-sm ml-auto max-w-[80%]">
                Your message
              </div>
              <div class="bg-pink-50 text-pink-800 p-2 rounded-lg text-sm mr-auto max-w-[80%]">
                Tutor response
              </div>
            </div>
          </div>

          <!-- Cyber Theme -->
          <div class="theme-preview bg-white border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 transition-all" data-theme="cyber" onclick="showThemePreview('cyber')">
            <div class="mb-3">
              <h4 class="font-semibold text-gray-800">Cyber Neon</h4>
              <p class="text-sm text-gray-600">Futuristic vibes</p>
            </div>
            <div class="space-y-2">
              <div style="background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);" class="text-white p-2 rounded text-sm ml-auto max-w-[80%]">
                Your message
              </div>
              <div class="bg-gray-900 text-cyan-400 p-2 rounded text-sm mr-auto max-w-[80%]">
                Tutor response
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Custom Color Section -->
      <div class="mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Custom Colors</h3>
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Your Message Color</label>
              <input type="color" id="studentColorPicker" value="#3b82f6" 
                     class="w-full h-10 rounded border border-gray-300 cursor-pointer">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Tutor Message Color</label>
              <input type="color" id="tutorColorPicker" value="#f3f4f6" 
                     class="w-full h-10 rounded border border-gray-300 cursor-pointer">
            </div>
          </div>
          <button onclick="showThemePreview('custom')" 
                  class="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-200">
            <i class="fas fa-paint-brush mr-2"></i>Preview Custom Colors
          </button>
        </div>
      </div>

<!-- Theme Preview Popup -->
<div id="themePreviewPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-60">
  <div class="bg-white rounded-xl max-w-md w-full mx-4">
    <div class="p-6">
      <!-- Header -->
      <div class="flex justify-between items-center mb-4">
        <div>
          <h3 class="text-lg font-bold text-gray-800" id="previewThemeName">Theme Preview</h3>
          <p class="text-sm text-gray-600">See how your messages will look</p>
        </div>
        <button onclick="closeThemePreview()" class="text-gray-500 hover:text-gray-700 text-xl">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Live Preview -->
      <div class="bg-gray-50 rounded-lg p-4 max-h-60 overflow-y-auto mb-4" id="liveThemePreview">
        <div class="space-y-3">
          <div class="preview-student-message">
            Hey! I need help with this assignment 📚
          </div>
          <div class="preview-tutor-message">
            Of course! I'd be happy to help you. What specific part are you struggling with?
          </div>
          <div class="preview-student-message">
            I'm having trouble understanding the concept
          </div>
          <div class="preview-tutor-message">
            Let me break it down for you step by step. First, let's start with the basics...
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex space-x-3">
        <button onclick="closeThemePreview()" 
                class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
          Cancel
        </button>
        <button onclick="applyPreviewedTheme()" 
                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
          <i class="fas fa-check mr-2"></i>Apply Theme
        </button>
      </div>
    </div>
  </div>
</div>

      <!-- Action Buttons -->
      <div class="flex justify-between">
        <button onclick="resetToDefault()" 
                class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
          <i class="fas fa-undo mr-2"></i>Reset to Default
        </button>
        <div class="space-x-3">
          <button onclick="closeChatSettings()" 
                  class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Chat Theme Management
let currentChatTheme = 'default';
let previewedTheme = null;

// Load saved theme on page load
document.addEventListener('DOMContentLoaded', function() {
  loadSavedChatTheme();
});

// Open chat settings modal
function openChatSettings() {
  document.getElementById('chatSettingsModal').classList.remove('hidden');
  document.getElementById('dropdown-menu').classList.add('hidden');
  updateThemeSelection();
}

// Close chat settings modal
function closeChatSettings() {
  document.getElementById('chatSettingsModal').classList.add('hidden');
}

// Show theme preview popup
function showThemePreview(themeName) {
  previewedTheme = themeName;
  const popup = document.getElementById('themePreviewPopup');
  const previewArea = document.getElementById('liveThemePreview');
  const themeTitleElement = document.getElementById('previewThemeName');
  
  // Set theme name
  const themeNames = {
    'default': 'Classic Blue',
    'ocean': 'Ocean Waves',
    'sunset': 'Sunset Glow',
    'forest': 'Forest Green',
    'midnight': 'Midnight Dark',
    'candy': 'Sweet Candy',
    'cyber': 'Cyber Neon',
    'custom': 'Custom Colors'
  };
  
  themeTitleElement.textContent = themeNames[themeName] || 'Theme Preview';
  
  // Apply preview theme to popup messages
  applyPreviewTheme(themeName);
  
  // Show popup
  popup.classList.remove('hidden');
}

// Close theme preview popup
function closeThemePreview() {
  document.getElementById('themePreviewPopup').classList.add('hidden');
  previewedTheme = null;
}

// Apply previewed theme
function applyPreviewedTheme() {
  if (previewedTheme) {
    applyTheme(previewedTheme);
    saveChatTheme();
    closeThemePreview();
    closeChatSettings();
  }
}

// Apply preview theme to popup
function applyPreviewTheme(themeName) {
  const previewArea = document.getElementById('liveThemePreview');
  
  // Remove all theme classes
  previewArea.classList.remove('theme-ocean', 'theme-sunset', 'theme-forest', 'theme-midnight', 'theme-candy', 'theme-cyber');
  
  if (themeName === 'custom') {
    const studentColor = document.getElementById('studentColorPicker').value;
    const tutorColor = document.getElementById('tutorColorPicker').value;
    
    // Apply custom colors to preview
    const studentMessages = previewArea.querySelectorAll('.preview-student-message');
    const tutorMessages = previewArea.querySelectorAll('.preview-tutor-message');
    
    studentMessages.forEach(msg => {
      msg.style.background = studentColor;
      msg.style.color = getContrastColor(studentColor);
    });
    
    tutorMessages.forEach(msg => {
      msg.style.background = tutorColor;
      msg.style.color = getContrastColor(tutorColor);
    });
  } else if (themeName !== 'default') {
    previewArea.classList.add(`theme-${themeName}`);
  }
}

// Update theme selection UI
function updateThemeSelection() {
  document.querySelectorAll('.theme-preview').forEach(preview => {
    preview.classList.remove('selected', 'border-blue-500');
    if (preview.dataset.theme === currentChatTheme) {
      preview.classList.add('selected', 'border-blue-500');
    }
  });
}

// Apply theme
function applyTheme(themeName) {
  currentChatTheme = themeName;
  
  // Remove all theme classes
  document.body.classList.remove('theme-ocean', 'theme-sunset', 'theme-forest', 'theme-midnight', 'theme-candy', 'theme-cyber');
  
  // Apply new theme class
  if (themeName === 'custom') {
    const studentColor = document.getElementById('studentColorPicker').value;
    const tutorColor = document.getElementById('tutorColorPicker').value;
    
    // Apply custom colors
    document.documentElement.style.setProperty('--student-chat-bg', studentColor);
    document.documentElement.style.setProperty('--tutor-chat-bg', tutorColor);
    document.documentElement.style.setProperty('--student-chat-text', getContrastColor(studentColor));
    document.documentElement.style.setProperty('--tutor-chat-text', getContrastColor(tutorColor));
  } else if (themeName !== 'default') {
    document.body.classList.add(`theme-${themeName}`);
  }
  
  updateThemeSelection();
  updateChatMessages();
}

// Get contrast color (black or white) based on background
function getContrastColor(hexColor) {
  const r = parseInt(hexColor.substr(1, 2), 16);
  const g = parseInt(hexColor.substr(3, 2), 16);
  const b = parseInt(hexColor.substr(5, 2), 16);
  const brightness = (r * 299 + g * 587 + b * 114) / 1000;
  return brightness > 128 ? '#000000' : '#ffffff';
}

// Reset to default theme
function resetToDefault() {
  applyTheme('default');
  document.getElementById('studentColorPicker').value = '#3b82f6';
  document.getElementById('tutorColorPicker').value = '#f3f4f6';
}

// Save chat theme (with offline fallback)
async function saveChatTheme() {
  try {
    const themeData = {
      userId: loggedInStudentId || 'guest',
      theme: currentChatTheme,
      customColors: currentChatTheme === 'custom' ? {
        studentBg: document.getElementById('studentColorPicker').value,
        tutorBg: document.getElementById('tutorColorPicker').value
      } : null
    };

    // Try to save to server
    const response = await fetch('https://meme-s6lb.onrender.com/student/save-chat-theme', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(themeData)
    });

    if (response.ok) {
      const result = await response.json();
      if (result.success) {
        showNotification('Theme saved successfully! 🎨', 'success');
        return;
      }
    }
    
    // Fallback to localStorage if server fails
    localStorage.setItem('chatTheme', JSON.stringify(themeData));
    showNotification('Theme saved locally! 💾', 'success');
    
  } catch (error) {
    console.error('Error saving theme:', error);
    
    // Fallback to localStorage
    const themeData = {
      userId: loggedInStudentId || 'guest',
      theme: currentChatTheme,
      customColors: currentChatTheme === 'custom' ? {
        studentBg: document.getElementById('studentColorPicker').value,
        tutorBg: document.getElementById('tutorColorPicker').value
      } : null
    };
    
    localStorage.setItem('chatTheme', JSON.stringify(themeData));
    showNotification('Theme saved locally! 💾', 'success');
  }
}

// Load saved chat theme (with offline fallback)
async function loadSavedChatTheme() {
  try {
    // Try to load from server first
    const response = await fetch(`https://meme-s6lb.onrender.com/student/get-chat-theme?userId=${encodeURIComponent(loggedInStudentId || 'guest')}`);
    
    if (response.ok) {
      const result = await response.json();
      if (result.success && result.theme) {
        const themeData = result.theme;
        
        if (themeData.theme === 'custom' && themeData.customColors) {
          document.getElementById('studentColorPicker').value = themeData.customColors.studentBg;
          document.getElementById('tutorColorPicker').value = themeData.customColors.tutorBg;
          applyTheme('custom');
        } else {
          applyTheme(themeData.theme);
        }
        return;
      }
    }
    
    // Fallback to localStorage
    const savedTheme = localStorage.getItem('chatTheme');
    if (savedTheme) {
      const themeData = JSON.parse(savedTheme);
      
      if (themeData.theme === 'custom' && themeData.customColors) {
        document.getElementById('studentColorPicker').value = themeData.customColors.studentBg;
        document.getElementById('tutorColorPicker').value = themeData.customColors.tutorBg;
        applyTheme('custom');
      } else {
        applyTheme(themeData.theme);
      }
    }
    
  } catch (error) {
    console.error('Error loading saved theme:', error);
    
    // Try localStorage as final fallback
    try {
      const savedTheme = localStorage.getItem('chatTheme');
      if (savedTheme) {
        const themeData = JSON.parse(savedTheme);
        
        if (themeData.theme === 'custom' && themeData.customColors) {
          document.getElementById('studentColorPicker').value = themeData.customColors.studentBg;
          document.getElementById('tutorColorPicker').value = themeData.customColors.tutorBg;
          applyTheme('custom');
        } else {
          applyTheme(themeData.theme);
        }
      }
    } catch (localError) {
      console.error('Error loading from localStorage:', localError);
    }
  }
}

// Update existing chat messages with new theme
function updateChatMessages() {
  const chatHistory = document.getElementById('chat-history');
  if (chatHistory) {
    // Re-apply classes to existing messages
    chatHistory.querySelectorAll('.student-message, .tutor-message').forEach(msg => {
      // Force re-render by toggling a class
      msg.style.display = 'none';
      setTimeout(() => {
        msg.style.display = 'block';
      }, 10);
    });
  }
}

// Show notification
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${
    type === 'success' ? 'bg-green-500 text-white' : 
    type === 'error' ? 'bg-red-500 text-white' : 
    'bg-blue-500 text-white'
  }`;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// Add CSS for preview messages
const previewStyles = document.createElement('style');
previewStyles.textContent = `
  .preview-student-message {
    background: var(--student-chat-bg, #3b82f6) !important;
    color: var(--student-chat-text, #ffffff) !important;
    border-radius: var(--chat-border-radius, 1rem) !important;
    box-shadow: var(--chat-shadow, 0 2px 8px rgba(0,0,0,0.1)) !important;
    margin-left: auto;
    max-width: 70%;
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
  }

  .preview-tutor-message {
    background: var(--tutor-chat-bg, #f3f4f6) !important;
    color: var(--tutor-chat-text, #1f2937) !important;
    border-radius: var(--chat-border-radius, 1rem) !important;
    box-shadow: var(--chat-shadow, 0 2px 8px rgba(0,0,0,0.1)) !important;
    margin-right: auto;
    max-width: 70%;
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
  }
`;
document.head.appendChild(previewStyles);
</script>

</body>
</html>